# Seasonal SST Anomalies

**Description**: Seasonal SST Anomalies

**Indicator category**: Database pull with analysis

**Found in**: State of the Ecosystem - Gulf of Maine & Georges Bank (2018, 2019), State of the Ecosystem - Mid-Atlantic (2018, 2019)

**Contributor(s)**: Sean Hardison, Vincent Saba
  
**Data steward**: Sean Hardison, <sean.hardison@noaa.gov>
  
**Point of contact**: Sean Hardison, <sean.hardison@noaa.gov>
  
**Public availability statement**: Source data are available [here](https://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.highres.html).


## Methods
### Data sources
Data for seasonal sea surface tempature anomalies (Fig. \@ref(fig:MAB-SST-insitu)) were derived from the NOAA optimum interpolation sea surface temperature high resolution data set ([NOAA OISST V2](https://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.highres.html)) provided by NOAA/OAR/ESRL PSD, Boulder, CO. The data extend from 1981 to present, and provide a 0.25&deg; x 0.25&deg; global grid of SST measurements [@Reynolds2007]. 

### Data extraction 
Individual files containing daily mean SST data for each year during the period of 1981-present were downloaded from the [OI SST V5 site](https://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.highres.html). Yearly data provided as layered rasters were masked according to the extent of Northeast US Continental Shelf. Data were split into three month seasons for (Winter = Jan, Feb, Mar; Spring = Apr, May, Jun; Summer = July, August, September; Fall = Oct, Nov, Dec).  

### Data analysis
We calculated the long-term mean (LTM) for each season-specific stack of rasters over the period of 1982-2010, and then subtracted the (LTM) from daily mean SST values to find the SST anomaly for a given year. The use of climatological reference periods is a standard procedure for the calculation of meteorological anomalies [@WMO2017]. Prior to 2019 State of the Ecosystem reports, SST anomaly information made use of a 1982-2012 reference period. A 1982-2010 reference period was adopted to facilitate calculating anomalies from a standard [NOAA ESRL](https://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.highres.html) data set.

R code used in extraction and processing:
```{r, echo = T, eval = F}
#Processing for spatial SST anomaly

library(dplyr)
library(raster)
library(sf)
library(ggplot2)
library(ncdf4)
library(reshape2)

rast_prep <- function(r){
  r <- rotate(r) #Rotate
  r <- crop(r, extent(-77,-60,35,46)) #Crop
  return(r)
}

raw.dir <- "~/git/ecodata/inst/extdata/gridded"
crs <- "+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40
+lon_0=-77 +x_0=0 +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0"


#These data are large files that are not included among ecodata source files. They are accessible
#here: https://www.esrl.noaa.gov/psd/data/gridded/data.noaa.oisst.v2.highres.html
sst.2018 <- rast_prep(stack(file.path(raw.dir, "sst.day.mean.2018.nc")))
ltm <- rast_prep(stack(file.path(raw.dir, "sst.day.mean.ltm.1982-2010.nc")))

# save(sst.2018, file = "~/git/ecodata/inst/extdata/gridded/SST.2018.rdata")
# save(sst.2018, file = "~/git/ecodata/inst/extdata/gridded/SST.LTM.rdata")

winter.ltm <- ltm[[1:90]] 
spring.ltm <- ltm[[91:181]]
summer.ltm <- ltm[[182:273]]
fall.ltm <- ltm[[274:365]]

winter.anom <- sst.2018[[1:90]] - winter.ltm
spring.anom <- sst.2018[[91:181]] - spring.ltm
summer.anom <- sst.2018[[182:273]] - summer.ltm
fall.anom <- sst.2018[[274:365]] - fall.ltm


rast_process <- function(r, season){
  r <- stackApply(r, indices = rep(1,nlayers(r)),mean) #Find mean anomaly
  crs(r) <- crs #Add SOE CRS
  r <- disaggregate(r, 5) #interpolate step 1 - create higher res grid
  r <- focal(r, w=matrix(1,nrow=5,ncol=5), fun=mean,
             na.rm=TRUE, pad=TRUE) #interpolate step 2 - moving window
  r <- as(r, "SpatialPointsDataFrame") #Convert to ggplot-able object
  r <- as.data.frame(r)
  r <- r %>%
    reshape2::melt(id = c("y","x")) %>%
    dplyr::rename(Latitude = y, Longitude = x) %>%
    dplyr::select(-variable) %>% 
    mutate(Season = season) %>% 
    dplyr::rename(Value = value)
    
  return(r)
}

#Converts raster to data.frame for easy use with ggplot2
seasonal_sst_anomaly_gridded <- 
  rbind(rast_process(winter.anom,season = "Winter"),
      rast_process(spring.anom,season = "Spring"),
      rast_process(summer.anom, season = "Summer"),
      rast_process(fall.anom, season = "Fall"))

```


### Plotting
```{r MAB-SST, fig.width = 8, fig.height = 7, fig.cap = "Seasonal sea-surface temperature anomalies in the Mid-Atlantic Bight."}
#Coastline
coast <- ne_countries(scale = 10,
                          continent = "North America",
                          returnclass = "sf") %>%
             sf::st_transform(crs = crs)

#EPU shapefile
epu_sf_ma <- ecodata::epu_sf %>% 
  filter(EPU %in% c("MAB"))

#Map line parameters
map.lwd <- 0.4

# Set lat/lon window for maps
xmin = -81
xmax = -66
ymin = 35.5
ymax = 43
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
sst_ <- seasonal_oisst_anom_gridded 

sst_$Season <- factor(sst_$Season, levels = c("Winter",
                                            "Spring",
                                            "Summer",
                                            "Fall"))
sst_map <- 
  ggplot() +
  geom_tile(data = sst_, aes(x = Longitude, y = Latitude, fill = Value)) +
  geom_sf(data = coast, size = map.lwd) +
  geom_sf(data = epu_sf_ma, fill = "transparent", size = map.lwd) +
  scale_fill_gradient2(name = "Temp.\nAnomaly (Â°C)",
                       low = scales::muted("blue"),
                       mid = "white",
                       high = scales::muted("red"),
                       limits = c(-5,5)) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  facet_wrap(Season~.) +
  theme_map() +
  ggtitle("SST anomaly (2018)") +
  xlab("Longitude") +
  ylab("Latitude") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 8))
sst_map
```


