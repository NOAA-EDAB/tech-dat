# Seabird diet and productivity

**Description**: Common tern annual diet and productivity at seven Gulf of Maine colonies managed by the National Audubon Society's Seabird Restoration Program

**Indicator category**: Published method

**Found in**: State of the Ecosystem - New England (2019)

**Contributor(s)**: Don Lyons, Steve Kress, Paula Shannon, Sue Schubel
  
**Data steward**: Don Lyons, <dlyons@audubon.org>
  
**Point of contact**: Don Lyons, <dlyons@audubon.org>
  
**Public availability statement**: Please email dlyons@audubon.org for further information and queries on this indicator source data.

## Methods

**Chick diet**

Common tern chick diet was quantified at each of the seven nesting sites (Fig. \@ref(fig:map-and-prey)a) by observing chick provisioning from portable observation blinds. The locations of observation blinds within each site were chosen to maximize the number of visible nests, and provisioning observations took place between mid-June and early August annually. Observations of chick diet were made during one or two three to four hour periods throughout the day, but typically proceed according to nest activity levels (moreso in the morning hours). Observations began with chicks as soon as they hatched, and continue until the chicks fledged or died. 

Most common tern prey species were identifiable to the species level due to distinct size, color and shape. However, when identification was not possible or was unclear, prey species were listed as "unknown" or "unknown fish". More detailed methods can be found in @hall2000. 

**Nest productivity**

Common tern nest productivity, in terms of the number of fledged chicks per nest, was collected annually from fenced enclosures at island nesting sites (known as "productivity plots"). Newly hatched chicks within these enclosures were weighed, marked or banded, and observed until fledging, death, or until a 15 day period had passed when chicks were assumed to have fledged. Productivity was also quantified from observer blinds for nests outside of the productivity plots where chicks were marked for identification. More detailed methods for quantifying nest productivity can be found in @hall2004


### Data sources

Common tern diet and nest productivity data were provided by the National Audubon Society's Seabird Restoration Program.

### Data processing

Diet and productivity data were formatted for inclusion in the ecodata R package using the following R code.

<!-- {{ProcessStart}} -->
```{r, eval = F, echo = T}
# Process raw common tern productivity and diet data

# If save == TRUE, processed data are saved as a .Rds file to the data directory. 

# Function returns a processed data frame containing time series of productivity and diet
# composition for common tern at different islands in southern Gulf of Maine. The first three letters
# in the variable "Var" correspond to the island at which sampling occurred, with COTE referring to 
# Common Tern. If "Var" includes productivity, then "Value" is the average number of fledged chicks.
# Otherwise, if "Var" specifies diet, then  "Value"  is equal to the count of observed prey type. 
# For example, "EER COTE Diet Amphipod" refers to the number of preyed upon amphipods observed at Eastern
# Egg Rock in a given year. 

library(dplyr)
library(tidyr)

#Get raw data
raw.dir <- here::here("data-raw")


get_commontern <- function(save_clean = F){

  d <- read.csv(file.path(raw.dir,"Audubon SRP Common Tern Data.csv"))
  
  #Process
  common_tern <- d %>%
    filter(Island != "") %>% 
    tidyr::gather(., Var, Value, -Year, -Species, -Island) %>%
    mutate(Species = ifelse(Var != "Productivity",
                                   paste(Species, "Diet"), "COTE")) %>% 
    unite(., "Var", c("Island", "Species", "Var"), sep = " ") %>% 
    dplyr::rename(Time = Year) %>% 
    mutate(EPU = "GOM",
                  Units = ifelse(stringr::str_detect(Var, "Productivity"),
                                 "fledged chicks per nest","N")) 
  
  if (save_clean){

    usethis::use_data(common_tern, overwrite = T)
  } else {
    return(common_tern)
  }
}

  


```
<!-- {{ProcessEnd}} -->

### Data analysis

Raw diet data were used to create time series of mean shannon diversity through time and across study sites using the `vegan` R package [@R-vegan]. Diet diversity is presented along with nest productivity (+/- 1 SE) below.

```{r diet-div, eval = T, echo = T}
#Calculating time series of diversity indices using the vegan package. 
diet_div <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>% 
  group_by(Island, Time) %>%
  dplyr::summarise(evenness = diversity(Value)/log(specnumber(Value)),
                   shannon = diversity(Value),
                   simpson = diversity(Value, index = "simpson")) %>% 
  gather(.,Var,Value,-Island, -Time) %>% 
  group_by(Var, Time) %>%
  dplyr::summarize(Value = mean(Value, na.rm = T),
                   sd = sd(Value, na.rm = T),
                   n = n()) %>%
  group_by(Var) %>% 
  mutate(hline = mean(Value, na.rm = T))
```


```{r tern-prod-div, fig.cap = "a. Mean common tern productivity at nesting sites in Gulf of Maine. Error bars show +/- 1 SE of the mean. b. Shannon diversity of common tern diets observed at nesting sites in Gulf of Maine. Diversity of common tern diets has been predominantly above the long-term mean since 2006.",fig.width = 8, fig.asp = 0.25, echo = T}
aggregate_prod <- ecodata::common_tern %>% 
    filter(!str_detect(Var, "Diet|Sum"))  %>% 
  mutate(Island = word(Var, 1),
         Var = word(Var, 3),
         Island = plyr::mapvalues(Island, from = c("EER","JI","MR","OGI","PINWR","SINWR","STI"),
                                  to = c("Eastern Egg Rock", "Jenny Island", "Matinicus Rock", "Outer Green Island", "Pond Island", "Seal Island","Stratton Island"))) %>%
  group_by(Time) %>% 
  dplyr::summarise(Mean = mean(Value, na.rm = T),
                   SE = sd(Value, na.rm = T)/sqrt(n()),
                   SD = sd(Value, na.rm = T),
                   n = n()) %>% 
  mutate(Mean = ifelse(is.na(SE),NA,Mean),
         se.low = Mean - SE,
         se.high = Mean + SE,
         hline = mean(Mean, na.rm = T))

prodplot <- aggregate_prod %>% ggplot() +
#Highlight last ten years
  annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line(aes(x = Time, y = Mean), size = lwd-0.75) +
  geom_point(aes(x = Time, y = Mean), size = pcex-0.75) +
  geom_gls(aes(x = Time, y = Mean)) +
  geom_errorbar(aes(x = Time,
                    ymin = se.low,
                  ymax = se.high), 
                width = 0.25) +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1991,2018)) +
  guides(color = FALSE) +
  ggtitle("Common tern productivity") +
  ylab(expression("Fledged chicks per nest")) +
  xlab("Time")+
  geom_hline(aes(yintercept = hline),
           color = "black",
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  labs(tag = "a")  +
  theme_ts() +
  theme(title = element_text(size = 7))

shannon <- diet_div %>% 
  filter(Var == "shannon") %>% 
ggplot(aes(x = Time, y = Value)) +
      annotate("rect", fill = shade.fill, alpha = shade.alpha,
      xmin = x.shade.min , xmax = x.shade.max,
      ymin = -Inf, ymax = Inf) +
  geom_line() +
  geom_point() +
  #geom_gls() +
  scale_x_continuous(expand = c(0.01, 0.01),limits = c(1992,2018)) +
  ggtitle("Common tern diet diversity")+
  ylab(expression("Shannon Diversity")) +
  xlab("")+
  geom_hline(aes(yintercept = hline),
           size = hline.size,
           alpha = hline.alpha,
           linetype = hline.lty) +
  labs(tag = "b")  +
  theme_ts() +
  theme(title = element_text(size = 7))

prodplot + shannon + plot_layout(ncol = 2, widths=c(4,4))
```

Along with nest productivity and diet diversity indices, we presented maps of sampling sites in Gulf of Maine and mean prey frequencies across sites. Prey occurring in less than 5\\% of common tern diets was excluded for visual clarity. 

```{r map-and-prey, fig.cap = "Common terns: a. Locations of the seven sampled common tern nesting sites in Gulf of Maine (EER = Eastern Egg Rock, JI = Jenny Island, MR = Matinicus Rock, OGI = Outer Green Island, PINWR = Pond Island National Wildlife Refuge, SINWR = Seal Island National Wildlife Refuge, STI = Stratton Island), and b. Prey frequencies in the diets of common tern observed across the seven colonies in Gulf of Maine. Prey occurring in <5\\% of common tern diets were excluded for clarity.", fig.height = 4}

#Map subfig
# Set lat/lon window for maps
xmin = -70.5
xmax = -68.25
ymin = 43
ymax = 44.5
xlims <- c(xmin, xmax)
ylims <- c(ymin, ymax)
island_loc <- data.frame(Island = c("EER","JI","MR","OGI",
                                    "PINWR","SINWR","STI"),
                         Latitude = c(43.861,43.764,43.785,43.650,
                                      43.739,43.886,43.505),
                         Longitude = c(-69.382,-69.909,-68.854,-70.124,
                                       -69.771,-68.742,-70.312))
islands <- ggplot() +
  geom_sf(data = new_england, size = map.lwd) +
  geom_point(data = island_loc, aes(x = Longitude, y = Latitude)) +
  geom_label_repel(data = island_loc, aes(x = Longitude, y = Latitude,
                                          label = Island), nudge_y  = -0.1, 
                   size = 2.5) +
  coord_sf(crs = crs, xlim = xlims, ylim = ylims) +
  theme_map() +
  ggtitle("Common tern study sites") +
  xlab("Longitude") +
  ylab("Latitude") +
  labs(tag = "a")  +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.75),
        legend.key = element_blank(),
        axis.title = element_text(size = 11),
        strip.background = element_blank(),
        strip.text=element_text(hjust=0),
        axis.text = element_text(size = 6),
        title = element_text(size = 7))
# inset_states <- new_england %>% filter(STATE_NAME %in% c("Maine",
#                                                          "New Hampshire",
#                                                          "Massachusetts"))
# Set lat/lon window for maps
# xmin2 = -72
# xmax2 = -66.25
# ymin2 = 42.5
# ymax2 = 47.5
# xlims2 <- c(xmin2, xmax2)
# ylims2 <- c(ymin2, ymax2)
# NE <- ggplotGrob(
# ggplot()+
#   geom_sf(data = new_england, size = map.lwd) +
#   coord_sf(crs = crs, xlim = xlims2, ylim = ylims2) +
#   annotate("rect", xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, color = "black",
#            size = 0.1, fill = "transparent") +
#   theme_map() +
#   xlab("") +
#   ylab("") +
#   theme(panel.border = element_rect(colour = "black", fill = "transparent", size=0.75),
#         plot.background = element_rect(fill = "transparent", colour = NA),
#         legend.key = element_blank(),
#         axis.title = element_text(size = 11),
#         strip.background = element_blank(),
#         strip.text=element_text(hjust=0),
#         axis.text = element_blank())
# )
# full_map <- islands +
#   annotation_custom(grob = NE, xmin = -69, xmax = -68.25, ymin = 42.9, ymax = 43.6)


# Prey freq stacked bar
prey_freq <- ecodata::common_tern %>% 
  filter(str_detect(Var, "Diet"),
         !str_detect(Var, "Sum")) %>% 
    mutate(Island = word(Var, 1),
         Var = word(Var, 4)) %>%
    group_by(Var, Time) %>% 
    dplyr::summarise(Value = sum(Value, na.rm = T)) %>% 
    group_by(Time) %>% 
    mutate(Freq = Value/sum(Value, na.rm = T)) %>% 
    group_by(Var) %>% 
  mutate(hline = mean(Freq, na.rm = T))

diet_freq_bar <- prey_freq %>%
  filter(Freq > 0.05) %>%
  dplyr::mutate(Prey = gsub("\\.", " ", Var)) %>%
  dplyr::mutate(Prey = gsub("Invertebrate", "Invert.", Prey)) %>%
  # dplyr::rename(Prey = Var) %>%
  ggplot(aes(x = Time, y = Freq, fill = Prey)) +
  geom_bar(stat = "identity") +
    # geom_bar_interactive(aes(tooltip = paste(Prey,round(Freq,2),Time)),stat = "identity") +
  scale_fill_manual(values = RColorBrewer::brewer.pal(10,"Paired")) +
  ggtitle("Prey composition") +
  ylab("Proportion of prey items") +
  labs(tag = "b")  +
  theme_ts() +
  theme(title = element_text(size = 7))


# diet_freq_bar <- girafe(ggobj = diet_freq_bar)
# diet_freq_bar <- girafe_options(diet_freq_bar, opts_zoom(max = 5) )
islands + diet_freq_bar + plot_layout(ncol = 2, widths=c(4,4))
```
