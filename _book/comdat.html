<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>17 Commercial Landings Data | Technical Documentation, State of the Ecosystem Report</title>
  <meta name="description" content="This book documents each indicator and analysis used in State of the Ecosystem reporting" />
  <meta name="generator" content="bookdown 0.12 and GitBook 2.6.7" />

  <meta property="og:title" content="17 Commercial Landings Data | Technical Documentation, State of the Ecosystem Report" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book documents each indicator and analysis used in State of the Ecosystem reporting" />
  <meta name="github-repo" content="NOAA-EDAB/tech-doc" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="17 Commercial Landings Data | Technical Documentation, State of the Ecosystem Report" />
  
  <meta name="twitter:description" content="This book documents each indicator and analysis used in State of the Ecosystem reporting" />
  

<meta name="author" content="Northeast Fisheries Science Center" />


<meta name="date" content="2019-08-20" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="ichthyoplankton-diversity.html">
<link rel="next" href="long-term-sea-surface-temperature.html">
<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="assets/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Technical Documentation, State of the Ecosystem Report</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="erddap.html"><a href="erddap.html"><i class="fa fa-check"></i><b>1</b> Data and Code Access</a><ul>
<li class="chapter" data-level="1.0.1" data-path="erddap.html"><a href="erddap.html#about"><i class="fa fa-check"></i><b>1.0.1</b> About</a></li>
<li class="chapter" data-level="1.0.2" data-path="erddap.html"><a href="erddap.html#accessing-source-data-and-build-code"><i class="fa fa-check"></i><b>1.0.2</b> Accessing source data and build code</a></li>
<li class="chapter" data-level="1.0.3" data-path="erddap.html"><a href="erddap.html#building-the-document"><i class="fa fa-check"></i><b>1.0.3</b> Building the document</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="aggroups.html"><a href="aggroups.html"><i class="fa fa-check"></i><b>2</b> Aggregate Groups</a><ul>
<li class="chapter" data-level="2.1" data-path="aggroups.html"><a href="aggroups.html#methods"><i class="fa fa-check"></i><b>2.1</b> Methods</a><ul>
<li class="chapter" data-level="2.1.1" data-path="aggroups.html"><a href="aggroups.html#data-sources"><i class="fa fa-check"></i><b>2.1.1</b> Data sources</a></li>
<li class="chapter" data-level="2.1.2" data-path="aggroups.html"><a href="aggroups.html#data-extraction"><i class="fa fa-check"></i><b>2.1.2</b> Data extraction</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html"><i class="fa fa-check"></i><b>3</b> Annual SST Cycles</a><ul>
<li class="chapter" data-level="3.1" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html#methods-1"><i class="fa fa-check"></i><b>3.1</b> Methods</a><ul>
<li class="chapter" data-level="3.1.1" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html#data-sources-1"><i class="fa fa-check"></i><b>3.1.1</b> Data sources</a></li>
<li class="chapter" data-level="3.1.2" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html#data-extraction-1"><i class="fa fa-check"></i><b>3.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="3.1.3" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html#data-analysis"><i class="fa fa-check"></i><b>3.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="3.1.4" data-path="annual-sst-cycles.html"><a href="annual-sst-cycles.html#plotting"><i class="fa fa-check"></i><b>3.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="aquaculture.html"><a href="aquaculture.html"><i class="fa fa-check"></i><b>4</b> Aquaculture</a><ul>
<li class="chapter" data-level="4.1" data-path="aquaculture.html"><a href="aquaculture.html#methods-2"><i class="fa fa-check"></i><b>4.1</b> Methods</a><ul>
<li class="chapter" data-level="4.1.1" data-path="aquaculture.html"><a href="aquaculture.html#data-sources-2"><i class="fa fa-check"></i><b>4.1.1</b> Data sources</a></li>
<li class="chapter" data-level="4.1.2" data-path="aquaculture.html"><a href="aquaculture.html#data-extraction-2"><i class="fa fa-check"></i><b>4.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="4.1.3" data-path="aquaculture.html"><a href="aquaculture.html#data-analysis-1"><i class="fa fa-check"></i><b>4.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="4.1.4" data-path="aquaculture.html"><a href="aquaculture.html#data-processing"><i class="fa fa-check"></i><b>4.1.4</b> Data processing</a></li>
<li class="chapter" data-level="4.1.5" data-path="aquaculture.html"><a href="aquaculture.html#plotting-1"><i class="fa fa-check"></i><b>4.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bennet-indicator.html"><a href="bennet-indicator.html"><i class="fa fa-check"></i><b>5</b> Bennet Indicator</a><ul>
<li class="chapter" data-level="5.1" data-path="bennet-indicator.html"><a href="bennet-indicator.html#methods-3"><i class="fa fa-check"></i><b>5.1</b> Methods</a><ul>
<li class="chapter" data-level="5.1.1" data-path="bennet-indicator.html"><a href="bennet-indicator.html#data-sources-3"><i class="fa fa-check"></i><b>5.1.1</b> Data sources</a></li>
<li class="chapter" data-level="5.1.2" data-path="bennet-indicator.html"><a href="bennet-indicator.html#data-extraction-3"><i class="fa fa-check"></i><b>5.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="5.1.3" data-path="bennet-indicator.html"><a href="bennet-indicator.html#data-analysis-2"><i class="fa fa-check"></i><b>5.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="5.1.4" data-path="bennet-indicator.html"><a href="bennet-indicator.html#data-processing-1"><i class="fa fa-check"></i><b>5.1.4</b> Data processing</a></li>
<li class="chapter" data-level="5.1.5" data-path="bennet-indicator.html"><a href="bennet-indicator.html#plotting-2"><i class="fa fa-check"></i><b>5.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html"><i class="fa fa-check"></i><b>6</b> Bottom temperatures</a><ul>
<li class="chapter" data-level="6.1" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#methods-4"><i class="fa fa-check"></i><b>6.1</b> Methods</a><ul>
<li class="chapter" data-level="6.1.1" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#data-sources-4"><i class="fa fa-check"></i><b>6.1.1</b> Data sources</a></li>
<li class="chapter" data-level="6.1.2" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#data-extraction-4"><i class="fa fa-check"></i><b>6.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="6.1.3" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#data-analysis-3"><i class="fa fa-check"></i><b>6.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="6.1.4" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#data-processing-2"><i class="fa fa-check"></i><b>6.1.4</b> Data processing</a></li>
<li class="chapter" data-level="6.1.5" data-path="bottom-temperatures.html"><a href="bottom-temperatures.html#plotting-3"><i class="fa fa-check"></i><b>6.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html"><i class="fa fa-check"></i><b>7</b> Catch and Fleet Diversity</a><ul>
<li class="chapter" data-level="7.1" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#methods-5"><i class="fa fa-check"></i><b>7.1</b> Methods</a><ul>
<li class="chapter" data-level="7.1.1" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#data-sources-5"><i class="fa fa-check"></i><b>7.1.1</b> Data sources</a></li>
<li class="chapter" data-level="7.1.2" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#data-extraction-5"><i class="fa fa-check"></i><b>7.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="7.1.3" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#data-analysis-4"><i class="fa fa-check"></i><b>7.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="7.1.4" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#data-processing-3"><i class="fa fa-check"></i><b>7.1.4</b> Data processing</a></li>
<li class="chapter" data-level="7.1.5" data-path="catch-and-fleet-diversity.html"><a href="catch-and-fleet-diversity.html#plotting-4"><i class="fa fa-check"></i><b>7.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="chesapeake-bay-water-quality-standards-attainment.html"><a href="chesapeake-bay-water-quality-standards-attainment.html"><i class="fa fa-check"></i><b>8</b> Chesapeake Bay Water Quality Standards Attainment</a><ul>
<li class="chapter" data-level="8.1" data-path="chesapeake-bay-water-quality-standards-attainment.html"><a href="chesapeake-bay-water-quality-standards-attainment.html#methods-6"><i class="fa fa-check"></i><b>8.1</b> Methods</a><ul>
<li class="chapter" data-level="8.1.1" data-path="chesapeake-bay-water-quality-standards-attainment.html"><a href="chesapeake-bay-water-quality-standards-attainment.html#data-sources-6"><i class="fa fa-check"></i><b>8.1.1</b> Data sources</a></li>
<li class="chapter" data-level="8.1.2" data-path="chesapeake-bay-water-quality-standards-attainment.html"><a href="chesapeake-bay-water-quality-standards-attainment.html#data-analysis-5"><i class="fa fa-check"></i><b>8.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="8.1.3" data-path="chesapeake-bay-water-quality-standards-attainment.html"><a href="chesapeake-bay-water-quality-standards-attainment.html#data-processing-4"><i class="fa fa-check"></i><b>8.1.3</b> Data processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="chl-pp.html"><a href="chl-pp.html"><i class="fa fa-check"></i><b>9</b> Chlorophyll <em>a</em> and Primary Production</a><ul>
<li class="chapter" data-level="9.1" data-path="chl-pp.html"><a href="chl-pp.html#methods-7"><i class="fa fa-check"></i><b>9.1</b> Methods</a><ul>
<li class="chapter" data-level="9.1.1" data-path="chl-pp.html"><a href="chl-pp.html#data-sources-7"><i class="fa fa-check"></i><b>9.1.1</b> Data sources</a></li>
<li class="chapter" data-level="9.1.2" data-path="chl-pp.html"><a href="chl-pp.html#data-extraction-6"><i class="fa fa-check"></i><b>9.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="9.1.3" data-path="chl-pp.html"><a href="chl-pp.html#data-analysis-6"><i class="fa fa-check"></i><b>9.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="9.1.4" data-path="chl-pp.html"><a href="chl-pp.html#data-processing-5"><i class="fa fa-check"></i><b>9.1.4</b> Data processing</a></li>
<li class="chapter" data-level="9.1.5" data-path="chl-pp.html"><a href="chl-pp.html#plotting-5"><i class="fa fa-check"></i><b>9.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html"><i class="fa fa-check"></i><b>10</b> Fishing Community Climate Vulnerability</a><ul>
<li class="chapter" data-level="10.1" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html#methods-8"><i class="fa fa-check"></i><b>10.1</b> Methods</a><ul>
<li class="chapter" data-level="10.1.1" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html#data-sources-8"><i class="fa fa-check"></i><b>10.1.1</b> Data sources</a></li>
<li class="chapter" data-level="10.1.2" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html#data-extraction-7"><i class="fa fa-check"></i><b>10.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="10.1.3" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html#data-analysis-7"><i class="fa fa-check"></i><b>10.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="10.1.4" data-path="fishing-community-climate-vulnerability.html"><a href="fishing-community-climate-vulnerability.html#plotting-6"><i class="fa fa-check"></i><b>10.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="conceptual-models.html"><a href="conceptual-models.html"><i class="fa fa-check"></i><b>11</b> Conceptual Models</a><ul>
<li class="chapter" data-level="11.1" data-path="conceptual-models.html"><a href="conceptual-models.html#methods-9"><i class="fa fa-check"></i><b>11.1</b> Methods</a><ul>
<li class="chapter" data-level="11.1.1" data-path="conceptual-models.html"><a href="conceptual-models.html#data-sources-9"><i class="fa fa-check"></i><b>11.1.1</b> Data sources</a></li>
<li class="chapter" data-level="11.1.2" data-path="conceptual-models.html"><a href="conceptual-models.html#data-extraction-8"><i class="fa fa-check"></i><b>11.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="11.1.3" data-path="conceptual-models.html"><a href="conceptual-models.html#data-analysis-8"><i class="fa fa-check"></i><b>11.1.3</b> Data analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html"><i class="fa fa-check"></i><b>12</b> Fish Condition Indicator</a><ul>
<li class="chapter" data-level="12.1" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html#methods-10"><i class="fa fa-check"></i><b>12.1</b> Methods</a><ul>
<li class="chapter" data-level="12.1.1" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html#data-sources-10"><i class="fa fa-check"></i><b>12.1.1</b> Data sources</a></li>
<li class="chapter" data-level="12.1.2" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html#data-extraction-9"><i class="fa fa-check"></i><b>12.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="12.1.3" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html#data-analysis-9"><i class="fa fa-check"></i><b>12.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="12.1.4" data-path="fish-condition-indicator.html"><a href="fish-condition-indicator.html#plotting-7"><i class="fa fa-check"></i><b>12.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="epu.html"><a href="epu.html"><i class="fa fa-check"></i><b>13</b> Ecological Production Units</a><ul>
<li class="chapter" data-level="13.1" data-path="epu.html"><a href="epu.html#methods-11"><i class="fa fa-check"></i><b>13.1</b> Methods</a><ul>
<li class="chapter" data-level="13.1.1" data-path="epu.html"><a href="epu.html#data-sources-11"><i class="fa fa-check"></i><b>13.1.1</b> Data sources</a></li>
<li class="chapter" data-level="13.1.2" data-path="epu.html"><a href="epu.html#data-extraction-10"><i class="fa fa-check"></i><b>13.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="13.1.3" data-path="epu.html"><a href="epu.html#data-analysis-10"><i class="fa fa-check"></i><b>13.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="13.1.4" data-path="epu.html"><a href="epu.html#data-processing-6"><i class="fa fa-check"></i><b>13.1.4</b> Data processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="gulf-stream-index.html"><a href="gulf-stream-index.html"><i class="fa fa-check"></i><b>14</b> Gulf Stream Index</a><ul>
<li class="chapter" data-level="14.1" data-path="gulf-stream-index.html"><a href="gulf-stream-index.html#methods-12"><i class="fa fa-check"></i><b>14.1</b> Methods</a><ul>
<li class="chapter" data-level="14.1.1" data-path="gulf-stream-index.html"><a href="gulf-stream-index.html#data-sources-12"><i class="fa fa-check"></i><b>14.1.1</b> Data sources</a></li>
<li class="chapter" data-level="14.1.2" data-path="gulf-stream-index.html"><a href="gulf-stream-index.html#data-analysis-11"><i class="fa fa-check"></i><b>14.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="14.1.3" data-path="gulf-stream-index.html"><a href="gulf-stream-index.html#data-processing-7"><i class="fa fa-check"></i><b>14.1.3</b> Data Processing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html"><i class="fa fa-check"></i><b>15</b> Harbor Porpoise Bycatch</a><ul>
<li class="chapter" data-level="15.1" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html#methods-13"><i class="fa fa-check"></i><b>15.1</b> Methods</a><ul>
<li class="chapter" data-level="15.1.1" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html#data-sources-13"><i class="fa fa-check"></i><b>15.1.1</b> Data sources</a></li>
<li class="chapter" data-level="15.1.2" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html#data-extraction-11"><i class="fa fa-check"></i><b>15.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="15.1.3" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html#data-analysis-12"><i class="fa fa-check"></i><b>15.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="15.1.4" data-path="harbor-porpoise-bycatch.html"><a href="harbor-porpoise-bycatch.html#plotting-8"><i class="fa fa-check"></i><b>15.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html"><i class="fa fa-check"></i><b>16</b> Ichthyoplankton Diversity</a><ul>
<li class="chapter" data-level="16.1" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#methods-14"><i class="fa fa-check"></i><b>16.1</b> Methods</a><ul>
<li class="chapter" data-level="16.1.1" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#data-sources-14"><i class="fa fa-check"></i><b>16.1.1</b> Data sources</a></li>
<li class="chapter" data-level="16.1.2" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#data-extraction-12"><i class="fa fa-check"></i><b>16.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="16.1.3" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#data-analysis-13"><i class="fa fa-check"></i><b>16.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="16.1.4" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#data-processing-8"><i class="fa fa-check"></i><b>16.1.4</b> Data processing</a></li>
<li class="chapter" data-level="16.1.5" data-path="ichthyoplankton-diversity.html"><a href="ichthyoplankton-diversity.html#plotting-9"><i class="fa fa-check"></i><b>16.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="comdat.html"><a href="comdat.html"><i class="fa fa-check"></i><b>17</b> Commercial Landings Data</a><ul>
<li class="chapter" data-level="17.1" data-path="comdat.html"><a href="comdat.html#methods-15"><i class="fa fa-check"></i><b>17.1</b> Methods</a><ul>
<li class="chapter" data-level="17.1.1" data-path="comdat.html"><a href="comdat.html#data-sources-15"><i class="fa fa-check"></i><b>17.1.1</b> Data sources</a></li>
<li class="chapter" data-level="17.1.2" data-path="comdat.html"><a href="comdat.html#data-extraction-13"><i class="fa fa-check"></i><b>17.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="17.1.3" data-path="comdat.html"><a href="comdat.html#data-analysis-14"><i class="fa fa-check"></i><b>17.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="17.1.4" data-path="comdat.html"><a href="comdat.html#plotting-10"><i class="fa fa-check"></i><b>17.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html"><i class="fa fa-check"></i><b>18</b> Long-term Sea Surface Temperature</a><ul>
<li class="chapter" data-level="18.1" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html#methods-16"><i class="fa fa-check"></i><b>18.1</b> Methods</a><ul>
<li class="chapter" data-level="18.1.1" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html#data-sources-16"><i class="fa fa-check"></i><b>18.1.1</b> Data sources</a></li>
<li class="chapter" data-level="18.1.2" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html#data-extraction-14"><i class="fa fa-check"></i><b>18.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="18.1.3" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html#data-processing-10"><i class="fa fa-check"></i><b>18.1.3</b> Data Processing</a></li>
<li class="chapter" data-level="18.1.4" data-path="long-term-sea-surface-temperature.html"><a href="long-term-sea-surface-temperature.html#plotting-11"><i class="fa fa-check"></i><b>18.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="mid-atlantic-harmful-algal-bloom-indicator.html"><a href="mid-atlantic-harmful-algal-bloom-indicator.html"><i class="fa fa-check"></i><b>19</b> Mid-Atlantic Harmful Algal Bloom Indicator</a><ul>
<li class="chapter" data-level="19.1" data-path="mid-atlantic-harmful-algal-bloom-indicator.html"><a href="mid-atlantic-harmful-algal-bloom-indicator.html#methods-17"><i class="fa fa-check"></i><b>19.1</b> Methods</a><ul>
<li class="chapter" data-level="19.1.1" data-path="mid-atlantic-harmful-algal-bloom-indicator.html"><a href="mid-atlantic-harmful-algal-bloom-indicator.html#data-sources-17"><i class="fa fa-check"></i><b>19.1.1</b> Data sources</a></li>
<li class="chapter" data-level="19.1.2" data-path="mid-atlantic-harmful-algal-bloom-indicator.html"><a href="mid-atlantic-harmful-algal-bloom-indicator.html#data-extraction-15"><i class="fa fa-check"></i><b>19.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="19.1.3" data-path="mid-atlantic-harmful-algal-bloom-indicator.html"><a href="mid-atlantic-harmful-algal-bloom-indicator.html#data-analysis-15"><i class="fa fa-check"></i><b>19.1.3</b> Data analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="new-england-harmful-algal-bloom-indicator.html"><a href="new-england-harmful-algal-bloom-indicator.html"><i class="fa fa-check"></i><b>20</b> New England Harmful Algal Bloom Indicator</a><ul>
<li class="chapter" data-level="20.1" data-path="new-england-harmful-algal-bloom-indicator.html"><a href="new-england-harmful-algal-bloom-indicator.html#methods-18"><i class="fa fa-check"></i><b>20.1</b> Methods</a><ul>
<li class="chapter" data-level="20.1.1" data-path="new-england-harmful-algal-bloom-indicator.html"><a href="new-england-harmful-algal-bloom-indicator.html#data-sources-18"><i class="fa fa-check"></i><b>20.1.1</b> Data sources</a></li>
<li class="chapter" data-level="20.1.2" data-path="new-england-harmful-algal-bloom-indicator.html"><a href="new-england-harmful-algal-bloom-indicator.html#data-extraction-16"><i class="fa fa-check"></i><b>20.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="20.1.3" data-path="new-england-harmful-algal-bloom-indicator.html"><a href="new-england-harmful-algal-bloom-indicator.html#data-analysis-16"><i class="fa fa-check"></i><b>20.1.3</b> Data analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html"><i class="fa fa-check"></i><b>21</b> Verified Records of Southern Kingfish</a><ul>
<li class="chapter" data-level="21.1" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html#methods-19"><i class="fa fa-check"></i><b>21.1</b> Methods</a><ul>
<li class="chapter" data-level="21.1.1" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html#data-sources-19"><i class="fa fa-check"></i><b>21.1.1</b> Data sources</a></li>
<li class="chapter" data-level="21.1.2" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html#data-extraction-17"><i class="fa fa-check"></i><b>21.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="21.1.3" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html#data-analysis-17"><i class="fa fa-check"></i><b>21.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="21.1.4" data-path="verified-records-of-southern-kingfish.html"><a href="verified-records-of-southern-kingfish.html#plotting-12"><i class="fa fa-check"></i><b>21.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="22" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html"><i class="fa fa-check"></i><b>22</b> Habitat Occupancy Models</a><ul>
<li class="chapter" data-level="22.1" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html#methods-20"><i class="fa fa-check"></i><b>22.1</b> Methods</a><ul>
<li class="chapter" data-level="22.1.1" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html#data-sources-20"><i class="fa fa-check"></i><b>22.1.1</b> Data sources</a></li>
<li class="chapter" data-level="22.1.2" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html#data-processing-11"><i class="fa fa-check"></i><b>22.1.2</b> Data processing</a></li>
<li class="chapter" data-level="22.1.3" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html#data-analysis-18"><i class="fa fa-check"></i><b>22.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="22.1.4" data-path="habitat-occupancy-models.html"><a href="habitat-occupancy-models.html#plotting-13"><i class="fa fa-check"></i><b>22.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html"><i class="fa fa-check"></i><b>23</b> Fish Productivity Indicator</a><ul>
<li class="chapter" data-level="23.1" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#methods-21"><i class="fa fa-check"></i><b>23.1</b> Methods</a><ul>
<li class="chapter" data-level="23.1.1" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#data-sources-21"><i class="fa fa-check"></i><b>23.1.1</b> Data sources</a></li>
<li class="chapter" data-level="23.1.2" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#data-extraction-18"><i class="fa fa-check"></i><b>23.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="23.1.3" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#data-analysis-19"><i class="fa fa-check"></i><b>23.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="23.1.4" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#data-processing-12"><i class="fa fa-check"></i><b>23.1.4</b> Data processing</a></li>
<li class="chapter" data-level="23.1.5" data-path="fish-productivity-indicator.html"><a href="fish-productivity-indicator.html#plotting-14"><i class="fa fa-check"></i><b>23.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="24" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html"><i class="fa fa-check"></i><b>24</b> Recreational Fishing Indicators</a><ul>
<li class="chapter" data-level="24.1" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html#methods-22"><i class="fa fa-check"></i><b>24.1</b> Methods</a><ul>
<li class="chapter" data-level="24.1.1" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html#data-sources-22"><i class="fa fa-check"></i><b>24.1.1</b> Data sources</a></li>
<li class="chapter" data-level="24.1.2" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html#data-analysis-20"><i class="fa fa-check"></i><b>24.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="24.1.3" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html#data-processing-13"><i class="fa fa-check"></i><b>24.1.3</b> Data processing</a></li>
<li class="chapter" data-level="24.1.4" data-path="recreational-fishing-indicators.html"><a href="recreational-fishing-indicators.html#plotting-15"><i class="fa fa-check"></i><b>24.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="25" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html"><i class="fa fa-check"></i><b>25</b> Right Whale Abundance</a><ul>
<li class="chapter" data-level="25.1" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#methods-23"><i class="fa fa-check"></i><b>25.1</b> Methods</a><ul>
<li class="chapter" data-level="25.1.1" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#data-sources-23"><i class="fa fa-check"></i><b>25.1.1</b> Data sources</a></li>
<li class="chapter" data-level="25.1.2" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#data-extraction-19"><i class="fa fa-check"></i><b>25.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="25.1.3" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#data-analysis-21"><i class="fa fa-check"></i><b>25.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="25.1.4" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#data-processing-14"><i class="fa fa-check"></i><b>25.1.4</b> Data processing</a></li>
<li class="chapter" data-level="25.1.5" data-path="right-whale-abundance.html"><a href="right-whale-abundance.html#plotting-16"><i class="fa fa-check"></i><b>25.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="26" data-path="seabird-diet-and-productivity.html"><a href="seabird-diet-and-productivity.html"><i class="fa fa-check"></i><b>26</b> Seabird diet and productivity</a><ul>
<li class="chapter" data-level="26.1" data-path="seabird-diet-and-productivity.html"><a href="seabird-diet-and-productivity.html#methods-24"><i class="fa fa-check"></i><b>26.1</b> Methods</a><ul>
<li class="chapter" data-level="26.1.1" data-path="seabird-diet-and-productivity.html"><a href="seabird-diet-and-productivity.html#data-sources-24"><i class="fa fa-check"></i><b>26.1.1</b> Data sources</a></li>
<li class="chapter" data-level="26.1.2" data-path="seabird-diet-and-productivity.html"><a href="seabird-diet-and-productivity.html#data-processing-15"><i class="fa fa-check"></i><b>26.1.2</b> Data processing</a></li>
<li class="chapter" data-level="26.1.3" data-path="seabird-diet-and-productivity.html"><a href="seabird-diet-and-productivity.html#data-analysis-22"><i class="fa fa-check"></i><b>26.1.3</b> Data analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="27" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html"><i class="fa fa-check"></i><b>27</b> Seasonal SST Anomalies</a><ul>
<li class="chapter" data-level="27.1" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html#methods-25"><i class="fa fa-check"></i><b>27.1</b> Methods</a><ul>
<li class="chapter" data-level="27.1.1" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html#data-sources-25"><i class="fa fa-check"></i><b>27.1.1</b> Data sources</a></li>
<li class="chapter" data-level="27.1.2" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html#data-extraction-20"><i class="fa fa-check"></i><b>27.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="27.1.3" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html#data-analysis-23"><i class="fa fa-check"></i><b>27.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="27.1.4" data-path="seasonal-sst-anomalies.html"><a href="seasonal-sst-anomalies.html#plotting-17"><i class="fa fa-check"></i><b>27.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="28" data-path="stockstatus.html"><a href="stockstatus.html"><i class="fa fa-check"></i><b>28</b> Single Species Status Indicator</a><ul>
<li class="chapter" data-level="28.1" data-path="stockstatus.html"><a href="stockstatus.html#methods-26"><i class="fa fa-check"></i><b>28.1</b> Methods</a><ul>
<li class="chapter" data-level="28.1.1" data-path="stockstatus.html"><a href="stockstatus.html#data-sources-26"><i class="fa fa-check"></i><b>28.1.1</b> Data sources</a></li>
<li class="chapter" data-level="28.1.2" data-path="stockstatus.html"><a href="stockstatus.html#data-extraction-21"><i class="fa fa-check"></i><b>28.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="28.1.3" data-path="stockstatus.html"><a href="stockstatus.html#data-processing-16"><i class="fa fa-check"></i><b>28.1.3</b> Data processing</a></li>
<li class="chapter" data-level="28.1.4" data-path="stockstatus.html"><a href="stockstatus.html#data-analysis-24"><i class="fa fa-check"></i><b>28.1.4</b> Data analysis</a></li>
<li class="chapter" data-level="28.1.5" data-path="stockstatus.html"><a href="stockstatus.html#plotting-18"><i class="fa fa-check"></i><b>28.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="29" data-path="species-density-estimates.html"><a href="species-density-estimates.html"><i class="fa fa-check"></i><b>29</b> Species Density Estimates</a><ul>
<li class="chapter" data-level="29.1" data-path="species-density-estimates.html"><a href="species-density-estimates.html#methods-27"><i class="fa fa-check"></i><b>29.1</b> Methods</a><ul>
<li class="chapter" data-level="29.1.1" data-path="species-density-estimates.html"><a href="species-density-estimates.html#data-sources-27"><i class="fa fa-check"></i><b>29.1.1</b> Data sources</a></li>
<li class="chapter" data-level="29.1.2" data-path="species-density-estimates.html"><a href="species-density-estimates.html#data-analysis-25"><i class="fa fa-check"></i><b>29.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="29.1.3" data-path="species-density-estimates.html"><a href="species-density-estimates.html#plotting-19"><i class="fa fa-check"></i><b>29.1.3</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="30" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html"><i class="fa fa-check"></i><b>30</b> Species Distribution Indicators</a><ul>
<li class="chapter" data-level="30.1" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html#methods-28"><i class="fa fa-check"></i><b>30.1</b> Methods</a><ul>
<li class="chapter" data-level="30.1.1" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html#data-sources-28"><i class="fa fa-check"></i><b>30.1.1</b> Data sources</a></li>
<li class="chapter" data-level="30.1.2" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html#data-analysis-26"><i class="fa fa-check"></i><b>30.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="30.1.3" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html#data-processing-17"><i class="fa fa-check"></i><b>30.1.3</b> Data processing</a></li>
<li class="chapter" data-level="30.1.4" data-path="species-distribution-indicators.html"><a href="species-distribution-indicators.html#plotting-20"><i class="fa fa-check"></i><b>30.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="31" data-path="survdat.html"><a href="survdat.html"><i class="fa fa-check"></i><b>31</b> Survey Data</a><ul>
<li class="chapter" data-level="31.1" data-path="survdat.html"><a href="survdat.html#methods-29"><i class="fa fa-check"></i><b>31.1</b> Methods</a><ul>
<li class="chapter" data-level="31.1.1" data-path="survdat.html"><a href="survdat.html#data-sources-29"><i class="fa fa-check"></i><b>31.1.1</b> Data sources</a></li>
<li class="chapter" data-level="31.1.2" data-path="survdat.html"><a href="survdat.html#data-extraction-22"><i class="fa fa-check"></i><b>31.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="31.1.3" data-path="survdat.html"><a href="survdat.html#data-analysis-27"><i class="fa fa-check"></i><b>31.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="31.1.4" data-path="survdat.html"><a href="survdat.html#plotting-21"><i class="fa fa-check"></i><b>31.1.4</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="32" data-path="thermal-habitat-projections.html"><a href="thermal-habitat-projections.html"><i class="fa fa-check"></i><b>32</b> Thermal Habitat Projections</a><ul>
<li class="chapter" data-level="32.1" data-path="thermal-habitat-projections.html"><a href="thermal-habitat-projections.html#methods-30"><i class="fa fa-check"></i><b>32.1</b> Methods</a><ul>
<li class="chapter" data-level="32.1.1" data-path="thermal-habitat-projections.html"><a href="thermal-habitat-projections.html#data-sources-30"><i class="fa fa-check"></i><b>32.1.1</b> Data sources</a></li>
<li class="chapter" data-level="32.1.2" data-path="thermal-habitat-projections.html"><a href="thermal-habitat-projections.html#data-analysis-28"><i class="fa fa-check"></i><b>32.1.2</b> Data analysis</a></li>
<li class="chapter" data-level="32.1.3" data-path="thermal-habitat-projections.html"><a href="thermal-habitat-projections.html#plotting-22"><i class="fa fa-check"></i><b>32.1.3</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="33" data-path="trend-analysis.html"><a href="trend-analysis.html"><i class="fa fa-check"></i><b>33</b> Trend Analysis</a><ul>
<li class="chapter" data-level="33.1" data-path="trend-analysis.html"><a href="trend-analysis.html#methods-31"><i class="fa fa-check"></i><b>33.1</b> Methods</a><ul>
<li class="chapter" data-level="33.1.1" data-path="trend-analysis.html"><a href="trend-analysis.html#data-sources-31"><i class="fa fa-check"></i><b>33.1.1</b> Data source(s)</a></li>
<li class="chapter" data-level="33.1.2" data-path="trend-analysis.html"><a href="trend-analysis.html#data-extraction-23"><i class="fa fa-check"></i><b>33.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="33.1.3" data-path="trend-analysis.html"><a href="trend-analysis.html#data-analysis-29"><i class="fa fa-check"></i><b>33.1.3</b> Data analysis</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="34" data-path="zooabund.html"><a href="zooabund.html"><i class="fa fa-check"></i><b>34</b> Zooplankton</a><ul>
<li class="chapter" data-level="34.1" data-path="zooabund.html"><a href="zooabund.html#methods-32"><i class="fa fa-check"></i><b>34.1</b> Methods</a><ul>
<li class="chapter" data-level="34.1.1" data-path="zooabund.html"><a href="zooabund.html#data-sources-32"><i class="fa fa-check"></i><b>34.1.1</b> Data sources</a></li>
<li class="chapter" data-level="34.1.2" data-path="zooabund.html"><a href="zooabund.html#data-extraction-24"><i class="fa fa-check"></i><b>34.1.2</b> Data extraction</a></li>
<li class="chapter" data-level="34.1.3" data-path="zooabund.html"><a href="zooabund.html#data-analysis-30"><i class="fa fa-check"></i><b>34.1.3</b> Data analysis</a></li>
<li class="chapter" data-level="34.1.4" data-path="zooabund.html"><a href="zooabund.html#data-processing-18"><i class="fa fa-check"></i><b>34.1.4</b> Data processing</a></li>
<li class="chapter" data-level="34.1.5" data-path="zooabund.html"><a href="zooabund.html#plotting-23"><i class="fa fa-check"></i><b>34.1.5</b> Plotting</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/NOAA-EDAB/tech-doc" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Technical Documentation, State of the Ecosystem Report</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="comdat" class="section level1">
<h1><span class="header-section-number">17</span> Commercial Landings Data</h1>
<p><strong>Description</strong>: Commercial landings data pull</p>
<p><strong>Found in</strong>: State of the Ecosystem - Gulf of Maine &amp; Georges Bank (2017, 2018, 2019), State of the Ecosystem - Mid-Atlantic (2017, 2018, 2019)</p>
<p><strong>Indicator category</strong>: Database pull</p>
<p><strong>Contributor(s)</strong>: Sean Lucey</p>
<p><strong>Data steward</strong>: Sean Lucey, <a href="mailto:Sean.Lucey@noaa.gov">Sean.Lucey@noaa.gov</a></p>
<p><strong>Point of contact</strong>: Sean Lucey, <a href="mailto:Sean.Lucey@noaa.gov">Sean.Lucey@noaa.gov</a></p>
<p><strong>Public availability statement</strong>: Raw data are not publically available due to confidentiality of individual fishery participants. Derived indicator outputs are available <a href="https://comet.nefsc.noaa.gov/erddap/tabledap/group_landings_soe_v1.html">here</a>.</p>
<div id="methods-15" class="section level2">
<h2><span class="header-section-number">17.1</span> Methods</h2>
<p>Fisheries dependent data for the Northeast Shelf extend back several decades. Data from the 1960s on are housed in the Commercial database (CFDBS) of the Northeast Fisheries Science Center which contains the commercial fisheries dealer purchase records (weigh-outs) collected by NMFS Statistical Reporting Specialists and state agencies from Maine to Virginia. The data format has changed slightly over the time series with three distinct time frames as noted in Table <a href="comdat.html#tab:calibration">17.1</a> below.</p>
<table>
<caption>
<span id="tab:calibration">Table 17.1: </span>Data formats
</caption>
<thead>
<tr>
<th style="text-align:left;">
Table
</th>
<th style="text-align:left;">
Years
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
WOLANDS
</td>
<td style="text-align:left;">
1964 - 1981
</td>
</tr>
<tr>
<td style="text-align:left;">
WODETS
</td>
<td style="text-align:left;">
1982 - 1993
</td>
</tr>
<tr>
<td style="text-align:left;">
CFDETS_AA
</td>
<td style="text-align:left;">
&gt; 1994
</td>
</tr>
</tbody>
</table>
<p>Comlands is an R database pull that consolidates the landings records from 1964 on and attempts to associate them with NAFO statistical areas (Figure <a href="comdat.html#fig:StatAreaMap">17.1</a>). The script is divided into three sections. The first pulls domestic landings data from the yearly landings tables and merges them into a single data source. The second section applies an algorithm to associate landings that are not allocated to a statistical area using similar characteristics of the trip to trips with known areas. The final section pulls foreign landings from the NAFO website and rectifies species and gear codes so they can be merged along with domestic landings.</p>
<div class="figure" style="text-align: center"><span id="fig:StatAreaMap"></span>
<img src="images/Stat_Area_Map.jpg" alt="Map of the North Atlantic Fisheries Organization (NAFO) Statistical Areas.  Colors represent the Ecological Production Unit (EPU) with which the statistical area is associated." width="50%" />
<p class="caption">
Figure 17.1: Map of the North Atlantic Fisheries Organization (NAFO) Statistical Areas. Colors represent the Ecological Production Unit (EPU) with which the statistical area is associated.
</p>
</div>
<p>During the first section, the Comlands script pulls the temporal and spatial information as well as vessel and gear characteristics associated with the landings in addition to the weight, value, and utilization code of each species in the landings record. The script includes a toggle to use landed weights as opposed to live weights. For all but shellfish species, live weights are used for the State of the Ecosystem report. Due to the volume of data contained within each yearly landings table, landings are aggregated by species, utilization code, and area as well as by month, gear, and tonnage class. All weights are then converted from pounds to metric tons. Landings values are also adjusted for inflation using the Producer Price Index by Commodity for Processed Foods and Feeds: Unprocessed and Packaged Fish. Inflation is based on January of the terminal year of the data pull ensuring that all values are in current dollar prices.</p>
<table class="table" style="width: auto !important; float: right; margin-left: 10px;">
<caption>
<span id="tab:gears">Table 17.2: </span>Gear types
</caption>
<thead>
<tr>
<th style="text-align:left;">
Major gear
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Otter Trawls
</td>
</tr>
<tr>
<td style="text-align:left;">
Scallop Dredges
</td>
</tr>
<tr>
<td style="text-align:left;">
Other Dredges
</td>
</tr>
<tr>
<td style="text-align:left;">
Gillnets
</td>
</tr>
<tr>
<td style="text-align:left;">
Longlines
</td>
</tr>
<tr>
<td style="text-align:left;">
Seines
</td>
</tr>
<tr>
<td style="text-align:left;">
Pots/Traps
</td>
</tr>
<tr>
<td style="text-align:left;">
Midwater
</td>
</tr>
<tr>
<td style="text-align:left;">
Other
</td>
</tr>
</tbody>
</table>
<p>Several species have additional steps after the data is pulled from CFDBS. Skates are typically landed as a species complex. In order to segregate the catch into species, the ratio of individual skate species in the NEFSC bottom trawl survey is used to disaggregate the landings. A similar algorithm is used to separate silver and offshore hake which can be mistaken for one another. Finally, Atlantic herring landings are pulled from a separate database as the most accurate weights are housed by the State of Maine. Comlands pulls from the State database and replaces the less accurate numbers from the federal database.</p>
<p>The majority of landings data are associated with a NAFO Statistical Area. For those that are not, Comlands attempts to assign them to an area using similar characteristics of trips where the area is known. To simplify this task, landings data are further aggregated into quarter and half year, small and large vessels, and eight major gear categories (Table <a href="comdat.html#tab:gears">17.2</a>). Landings are then proportioned to areas that meet similar characteristics based on the proportion of landings in each area by that temporal/vessel/gear combination. If a given attribute is unknown, the algorithm attempts to assign it one, once again based on matched characteristics of known trips. Statistical areas are then assigned to their respective <a href="epu.html#epu">Ecological Production Unit</a> (Table <a href="comdat.html#tab:statareas">17.3</a>).</p>
<table>
<caption>
<span id="tab:statareas">Table 17.3: </span>Statistical areas making up each EPU
</caption>
<thead>
<tr>
<th style="text-align:left;">
EPU
</th>
<th style="text-align:left;">
Stat Areas
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Gulf of Maine
</td>
<td style="text-align:left;">
500, 510, 512, 513, 514, 515
</td>
</tr>
<tr>
<td style="text-align:left;">
Georges Bank
</td>
<td style="text-align:left;">
521, 522, 523, 524, 525, 526, 551, 552, 561, 562
</td>
</tr>
<tr>
<td style="text-align:left;">
Mid-Atlantic
</td>
<td style="text-align:left;">
537, 539, 600, 612, 613, 614, 615, 616, 621, 622, 625, 626, 631, 632
</td>
</tr>
</tbody>
</table>
<p>The final step of Comlands is to pull the foreign landings from the <a href="https://www.nafo.int/Data/frames">NAFO database</a>. US landings are removed from this extraction so as not to be double counted. NAFO codes and CFDBS codes differ so the script rectifies those codes to ensure that the data is seamlessly merged into the domestic landings. Foreign landings are flagged so that they can be removed if so desired.</p>
<div id="data-sources-15" class="section level3">
<h3><span class="header-section-number">17.1.1</span> Data sources</h3>
<p>Comland is a database query of the NEFSC commercial fishery database (CFDBS). More information about the CFDBS is available <a href="https://inport.nmfs.noaa.gov/inport/item/27401">here</a>.</p>
</div>
<div id="data-extraction-13" class="section level3">
<h3><span class="header-section-number">17.1.2</span> Data extraction</h3>
<p>R code used in the extraction process described above:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Comland.r</span>
<span class="co">#Version now controlled by git - originally part of comcatch.r</span>
<span class="co">#Grab commercial landings data from US and Foreign countries (NAFO)</span>
<span class="co">#Need to fix menhaden data</span>
<span class="co">#SML</span>

<span class="co">#Requires the following files:</span>
<span class="co"># data.dir.2\\Comland_skates_hakes.R</span>
<span class="co"># data.dir\\Menhaden.csv</span>
<span class="co"># data.dir.3\\SS_NAFO_21A.csv</span>
<span class="co"># data.dir.3\\species.txt</span>

<span class="co">#User parameters</span>
<span class="cf">if</span>(<span class="kw">Sys.info</span>()[<span class="st">&#39;sysname&#39;</span>]<span class="op">==</span><span class="st">&quot;Windows&quot;</span>){
  data.dir   &lt;-<span class="st"> &quot;L:</span><span class="ch">\\</span><span class="st">EcoAP</span><span class="ch">\\</span><span class="st">Data</span><span class="ch">\\</span><span class="st">Commercial&quot;</span>
  data.dir.<span class="dv">2</span> &lt;-<span class="st"> &quot;L:</span><span class="ch">\\</span><span class="st">Rworkspace</span><span class="ch">\\</span><span class="st">RCom&quot;</span>
  data.dir.<span class="dv">3</span> &lt;-<span class="st"> &quot;L:</span><span class="ch">\\</span><span class="st">EcoAP</span><span class="ch">\\</span><span class="st">Data</span><span class="ch">\\</span><span class="st">NAFO&quot;</span>
  out.dir    &lt;-<span class="st"> &quot;L:</span><span class="ch">\\</span><span class="st">EcoAP</span><span class="ch">\\</span><span class="st">Data</span><span class="ch">\\</span><span class="st">Commercial&quot;</span>
  <span class="kw">memory.limit</span>(<span class="dv">4000</span>)
  channel &lt;-<span class="st"> </span><span class="kw">odbcDriverConnect</span>()
}

<span class="cf">if</span>(<span class="kw">Sys.info</span>()[<span class="st">&#39;sysname&#39;</span>]<span class="op">==</span><span class="st">&quot;Linux&quot;</span>){
  data.dir   &lt;-<span class="st"> &quot;/home/slucey/slucey/EcoAP/Data/Commercial&quot;</span>
  data.dir.<span class="dv">2</span> &lt;-<span class="st"> &quot;/home/slucey/slucey/Rworkspace/RCom&quot;</span>
  data.dir.<span class="dv">3</span> &lt;-<span class="st"> &quot;/home/slucey/slucey/EcoAP/Data/NAFO&quot;</span>
  out.dir    &lt;-<span class="st"> &quot;/home/slucey/slucey/EcoAP/Data/Commercial&quot;</span>
  uid &lt;-<span class="st"> &#39;slucey&#39;</span>
  <span class="kw">cat</span>(<span class="st">&quot;Oracle Password: &quot;</span>)
  pwd &lt;-<span class="st"> </span><span class="kw">scan</span>(<span class="kw">stdin</span>(), <span class="kw">character</span>(), <span class="dt">n =</span> <span class="dv">1</span>)
}

landed       &lt;-<span class="st"> &#39;y&#39;</span> <span class="co">#use landed weight for scallops and clams instead of live weight</span>
foreign      &lt;-<span class="st"> &#39;y&#39;</span> <span class="co">#Mark foreign landings and keep seperate</span>
adjust.ppi   &lt;-<span class="st"> &#39;y&#39;</span> <span class="co">#Adjust value for inflation</span>
use.existing &lt;-<span class="st"> &#39;n&#39;</span> <span class="co">#use raw data from a previous run - saves time</span>
sum.by       &lt;-<span class="st"> &#39;EPU&#39;</span> <span class="co">#Variable to sum landings by [EPU, stat.area]</span>

<span class="co">#Final year of query</span>
endyear &lt;-<span class="st"> </span><span class="dv">2016</span>
<span class="co">#If adjusting for inflation</span>
refyear  &lt;-<span class="st"> </span><span class="dv">2016</span>
refmonth &lt;-<span class="st"> </span><span class="dv">1</span>

<span class="co">#-------------------------------------------------------------------------------</span>
<span class="co">#Required packages</span>
<span class="kw">library</span>(RODBC); <span class="kw">library</span>(data.table); <span class="kw">library</span>(rgdal)

<span class="co">#-------------------------------------------------------------------------------</span>
<span class="co">#User created functions </span>
<span class="co">#Convert NA&#39;s to zeros</span>
na.zero &lt;-<span class="st"> </span><span class="cf">function</span>(x){
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(x[<span class="dv">1</span>, ])){
    <span class="cf">if</span>(<span class="kw">length</span>(<span class="kw">which</span>(<span class="kw">is.na</span>(x[, i]))) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
      x[<span class="kw">which</span>(<span class="kw">is.na</span>(x[, i])), i] &lt;-<span class="st"> </span><span class="dv">0</span>}
    }
    <span class="kw">return</span>(x)
  } 
  
<span class="co">#-------------------------------------------------------------------------------</span>
<span class="co">#Connect to database</span>
<span class="cf">if</span>(<span class="kw">Sys.info</span>()[<span class="st">&#39;sysname&#39;</span>] <span class="op">==</span><span class="st"> &quot;Windows&quot;</span>)channel &lt;-<span class="st"> </span><span class="kw">odbcDriverConnect</span>()
<span class="cf">if</span>(<span class="kw">Sys.info</span>()[<span class="st">&#39;sysname&#39;</span>] <span class="op">==</span><span class="st"> &quot;Linux&quot;</span>)  channel &lt;-<span class="st"> </span><span class="kw">odbcConnect</span>(<span class="st">&#39;sole&#39;</span>, uid, pwd)

<span class="cf">if</span>(use.existing <span class="op">==</span><span class="st"> &#39;n&#39;</span>){
  <span class="co">#Landings</span>
  tables &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">&#39;WOLANDS&#39;</span>, <span class="dv">64</span><span class="op">:</span><span class="dv">81</span>), 
              <span class="kw">paste0</span>(<span class="st">&#39;WODETS&#39;</span>,  <span class="dv">82</span><span class="op">:</span><span class="dv">93</span>), 
              <span class="kw">paste0</span>(<span class="st">&#39;CFDETS&#39;</span>,  <span class="dv">1994</span><span class="op">:</span>endyear, <span class="st">&#39;AA&#39;</span>))
  
  <span class="co">#Generate one table</span>
  comland &lt;-<span class="st"> </span><span class="kw">c</span>()
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(tables)){
    landings.qry &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;select year, month, negear, toncl1, nespp3, nespp4, area, </span>
<span class="st">                           spplivlb, spplndlb, sppvalue, utilcd</span>
<span class="st">                           from&quot;</span>, tables[i])
    
    comland.yr &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">sqlQuery</span>(channel, landings.qry))
    
    <span class="kw">setkey</span>(comland.yr,
           YEAR,
           MONTH,
           NEGEAR,
           TONCL1,
           NESPP3,
           NESPP4,
           AREA,
           UTILCD)
  
    <span class="cf">if</span>(landed <span class="op">==</span><span class="st"> &#39;y&#39;</span>) comland.yr[NESPP3 <span class="op">%in%</span><span class="st"> </span><span class="dv">743</span><span class="op">:</span><span class="dv">800</span>, SPPLIVLB <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLNDLB]
    
    <span class="co">#Sum landings and value</span>
    <span class="co">#landings</span>
    comland.yr[, V1 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVLB), by =<span class="st"> </span><span class="kw">key</span>(comland.yr)]
    <span class="co">#value</span>
    <span class="co">#Fix null values</span>
    comland.yr[<span class="kw">is.na</span>(SPPVALUE), SPPVALUE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
    comland.yr[, V2 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sum</span>(SPPVALUE), by =<span class="st"> </span><span class="kw">key</span>(comland.yr)]
    
    <span class="co">#Remove extra rows/columns</span>
    comland.yr &lt;-<span class="st"> </span><span class="kw">unique</span>(comland.yr, <span class="dt">by =</span> <span class="kw">key</span>(comland.yr))
    comland.yr[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVLB&#39;</span>, <span class="st">&#39;SPPLNDLB&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    
    <span class="co">#Rename summed columns</span>
    <span class="kw">setnames</span>(comland.yr, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVLB&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    
    comland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(comland, comland.yr))
  }
  
  <span class="cf">if</span>(landed <span class="op">==</span><span class="st"> &#39;n&#39;</span>) <span class="kw">save</span>(comland, <span class="dt">file =</span> <span class="kw">file.path</span>(out.dir, <span class="st">&quot;comland_raw_US.RData&quot;</span>))
  <span class="co">#Last run 8/31/16</span>
  <span class="cf">if</span>(landed <span class="op">==</span><span class="st"> &#39;y&#39;</span>) <span class="kw">save</span>(comland, <span class="dt">file =</span> <span class="kw">file.path</span>(out.dir, <span class="st">&quot;comland_raw_US_meatwt.RData&quot;</span>))
  <span class="co">#Last run 1/25/18 </span>
}
<span class="cf">if</span>(use.existing <span class="op">==</span><span class="st"> &#39;y&#39;</span>){
  <span class="cf">if</span>(landed <span class="op">==</span><span class="st"> &#39;n&#39;</span>) <span class="kw">load</span>(<span class="dt">file =</span> <span class="kw">file.path</span>(out.dir, <span class="st">&quot;comland_raw_US.RData&quot;</span>))
  <span class="cf">if</span>(landed <span class="op">==</span><span class="st"> &#39;y&#39;</span>) <span class="kw">load</span>(<span class="dt">file =</span> <span class="kw">file.path</span>(out.dir, <span class="st">&quot;comland_raw_US_meatwt.RData&quot;</span>))  
}

<span class="co">#-------------------------------------------------------------------------------</span>
<span class="co">#Convert from lbs to metric tons</span>
comland[, SPPLIVMT <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVLB <span class="op">*</span><span class="st"> </span><span class="fl">0.00045359237</span>]
comland[, SPPLIVLB <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]

<span class="co">#fix years</span>
comland[YEAR <span class="op">&lt;</span><span class="st"> </span><span class="dv">100</span>, YEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>YEAR <span class="op">+</span><span class="st"> </span>1900L]

<span class="cf">if</span>(adjust.ppi <span class="op">==</span><span class="st"> &#39;y&#39;</span>){
    <span class="co">#Adjust SPPVALUE for inflation</span>
    temp &lt;-<span class="st"> </span><span class="kw">tempfile</span>()
    <span class="kw">download.file</span>(<span class="st">&quot;http://download.bls.gov/pub/time.series/wp/wp.data.3.ProcessedFoods&quot;</span>, temp)
    inflate &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.delim</span>(temp))
    <span class="kw">unlink</span>(temp)
    
    inflate[, series_id <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;&quot;</span>, inflate[, series_id])]
    deflate &lt;-<span class="st"> </span>inflate[series_id <span class="op">==</span><span class="st"> &quot;WPU0223&quot;</span>, ]
    deflate[, MONTH <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substr</span>(period, <span class="dv">2</span>, <span class="dv">3</span>))]
    <span class="kw">setnames</span>(deflate, <span class="kw">c</span>(<span class="st">&#39;year&#39;</span>, <span class="st">&#39;value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;PPI&#39;</span>))
    deflate &lt;-<span class="st"> </span>deflate[, <span class="kw">list</span>(YEAR, MONTH, PPI)]
    
    <span class="co">#Set yearly deflator to 0 instead of 13 to match unknown month designation</span>
    deflate[MONTH <span class="op">==</span><span class="st"> </span><span class="dv">13</span>, MONTH <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
    deflate.base &lt;-<span class="st"> </span>deflate[YEAR <span class="op">==</span><span class="st"> </span>refyear <span class="op">&amp;</span><span class="st"> </span>MONTH <span class="op">==</span><span class="st"> </span>refmonth, PPI]
    
    comland &lt;-<span class="st"> </span><span class="kw">merge</span>(comland, deflate, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>), <span class="dt">all.x =</span> T)
    comland[, SPPVALUE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>((SPPVALUE <span class="op">*</span><span class="st"> </span>deflate.base) <span class="op">/</span><span class="st"> </span>PPI)]
    
    <span class="co">#Remove extra column</span>
    comland[, PPI <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
}
<span class="co">#Remove market categories of parts</span>
comland &lt;-<span class="st"> </span>comland[<span class="op">!</span>NESPP4 <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">119</span>, <span class="dv">123</span>, <span class="dv">125</span>, <span class="dv">127</span>, <span class="dv">812</span>, <span class="dv">819</span>, <span class="dv">828</span>, <span class="dv">829</span>, <span class="dv">1731</span>, <span class="dv">2351</span>,
                                  <span class="dv">2690</span>, <span class="dv">2699</span>, <span class="dv">3472</span>, <span class="kw">as.numeric</span>(<span class="kw">paste</span>(<span class="dv">348</span><span class="op">:</span><span class="dv">359</span>, <span class="dv">8</span>, <span class="dt">sep =</span> <span class="st">&#39;&#39;</span>)), 
                                  <span class="dv">3868</span>, <span class="kw">as.numeric</span>(<span class="kw">paste</span>(<span class="dv">469</span><span class="op">:</span><span class="dv">471</span>, <span class="dv">4</span>, <span class="dt">sep =</span> <span class="st">&#39;&#39;</span>)), 
                                  <span class="kw">as.numeric</span>(<span class="kw">paste</span>(<span class="dv">480</span><span class="op">:</span><span class="dv">499</span>, <span class="dv">8</span>, <span class="dt">sep =</span><span class="st">&#39;&#39;</span>)), <span class="dv">5018</span>, <span class="dv">5039</span>, 
                                  <span class="dv">5261</span>, <span class="dv">5265</span>), ]

<span class="co">#Generate NESPP3 and MKTCAT in comland data</span>
comland[NESPP4 <span class="op">&lt;</span><span class="st"> </span><span class="dv">100</span>,                MKTCAT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substring</span>(NESPP4, <span class="dv">2</span>, <span class="dv">2</span>))]
comland[NESPP4 <span class="op">&gt;</span><span class="st"> </span><span class="dv">99</span> <span class="op">&amp;</span><span class="st"> </span>NESPP4 <span class="op">&lt;</span><span class="st"> </span><span class="dv">1000</span>, MKTCAT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substring</span>(NESPP4, <span class="dv">3</span>, <span class="dv">3</span>))]
comland[NESPP4 <span class="op">&gt;</span><span class="st"> </span><span class="dv">999</span>,                MKTCAT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">substring</span>(NESPP4, <span class="dv">4</span>, <span class="dv">4</span>))]

<span class="co">#drop NESPP4</span>
comland[, NESPP4 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]

<span class="co">#Deal with Hakes and Skates------------------------------------------------------------------</span>
<span class="kw">source</span>(<span class="kw">file.path</span>(data.dir.<span class="dv">2</span>, <span class="st">&#39;Comland_skates_hakes.R&#39;</span>))

<span class="co">#get little skates and winter skates from skates(ns) - use survey in half years</span>
<span class="co">#Generate Half year variable in comland</span>
comland.skates &lt;-<span class="st"> </span>comland[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">365</span>, ]
comland.skates[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,  Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
comland.skates[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">12</span>, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]

<span class="kw">setkey</span>(skate.hake.us,
       YEAR,
       Half,
       AREA)

comland.skates &lt;-<span class="st"> </span><span class="kw">merge</span>(comland.skates, skate.hake.us, <span class="dt">by =</span> <span class="kw">key</span>(skate.hake.us), <span class="dt">all.x =</span> T)

comland.skates[, little       <span class="op">:</span><span class="er">=</span><span class="st"> </span>little.per <span class="op">*</span><span class="st"> </span>SPPLIVMT]
comland.skates[, little.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(little.per <span class="op">*</span><span class="st"> </span>SPPVALUE)]
comland.skates[<span class="kw">is.na</span>(little),       little       <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland.skates[<span class="kw">is.na</span>(little.value), little.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

comland.skates[, winter       <span class="op">:</span><span class="er">=</span><span class="st"> </span>winter.per <span class="op">*</span><span class="st"> </span>SPPLIVMT]
comland.skates[, winter.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(winter.per <span class="op">*</span><span class="st"> </span>SPPVALUE)]
comland.skates[<span class="kw">is.na</span>(winter),       winter       <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland.skates[<span class="kw">is.na</span>(winter.value), winter.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

comland.skates[, other.skate       <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">-</span><span class="st"> </span>(little       <span class="op">+</span><span class="st"> </span>winter)]
comland.skates[, other.skate.value <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPVALUE <span class="op">-</span><span class="st"> </span>(little.value <span class="op">+</span><span class="st"> </span>winter.value)]

<span class="co">#Little (366), winter (367), skates(ns) (365)</span>
<span class="co">#put skates in comland format to merge back</span>
little &lt;-<span class="st"> </span>comland.skates[, <span class="kw">list</span>(YEAR, Half, AREA, MONTH, NEGEAR,
                                TONCL1, NESPP3, UTILCD, MKTCAT, little, 
                                little.value)]
little[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">366</span>]
<span class="kw">setnames</span>(little, <span class="kw">c</span>(<span class="st">&#39;little&#39;</span>, <span class="st">&#39;little.value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
little &lt;-<span class="st"> </span>little[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]

winter &lt;-<span class="st"> </span>comland.skates[, <span class="kw">list</span>(YEAR, Half, AREA, MONTH, NEGEAR,
                                TONCL1, NESPP3, UTILCD, MKTCAT, winter, 
                                winter.value)]
winter[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">367</span>]
<span class="kw">setnames</span>(winter, <span class="kw">c</span>(<span class="st">&#39;winter&#39;</span>, <span class="st">&#39;winter.value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
winter &lt;-<span class="st"> </span>winter[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]

other &lt;-<span class="st"> </span>comland.skates[, <span class="kw">list</span>(YEAR, Half, AREA, MONTH, NEGEAR,
                               TONCL1, NESPP3, UTILCD, MKTCAT, other.skate, 
                               other.skate.value)]
other[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">365</span>]
<span class="kw">setnames</span>(other, <span class="kw">c</span>(<span class="st">&#39;other.skate&#39;</span>, <span class="st">&#39;other.skate.value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
other &lt;-<span class="st"> </span>other[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]

<span class="co">#merge all three and reformat for comland</span>
skates.add.back &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(little, winter, other))

skates.add.back[, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
<span class="kw">setcolorder</span>(skates.add.back, <span class="kw">names</span>(comland))

comland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(comland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">365</span>, ], skates.add.back))  

<span class="co">#get silver hake from mixed hakes - use survey in half years</span>
<span class="co">#Generate Half year variable in comland</span>
comland.hakes &lt;-<span class="st"> </span>comland[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">507</span>, ]
comland.hakes[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,  Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
comland.hakes[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">12</span>, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]

comland.hakes &lt;-<span class="st"> </span><span class="kw">merge</span>(comland.hakes, skate.hake.us, <span class="dt">by =</span> <span class="kw">key</span>(skate.hake.us), <span class="dt">all.x =</span> T)

comland.hakes[, silver       <span class="op">:</span><span class="er">=</span><span class="st"> </span>silver.per <span class="op">*</span><span class="st"> </span>SPPLIVMT]
comland.hakes[, silver.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(silver.per <span class="op">*</span><span class="st"> </span>SPPVALUE)]
comland.hakes[<span class="kw">is.na</span>(silver),       silver       <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland.hakes[<span class="kw">is.na</span>(silver.value), silver.value <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

comland.hakes[, off.hake       <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">-</span><span class="st"> </span>silver]
comland.hakes[, off.hake.value <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPVALUE <span class="op">-</span><span class="st"> </span>silver.value]

<span class="co">#Silver hake (509), mix hakes (507)</span>
<span class="co">#put hakes in comland format to merge back</span>
silver &lt;-<span class="st"> </span>comland.hakes[, <span class="kw">list</span>(YEAR, Half, AREA, MONTH, NEGEAR,
                               TONCL1, NESPP3, UTILCD, MKTCAT, silver, 
                               silver.value)]
silver[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">509</span>]
<span class="kw">setnames</span>(silver, <span class="kw">c</span>(<span class="st">&#39;silver&#39;</span>, <span class="st">&#39;silver.value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
silver &lt;-<span class="st"> </span>silver[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]

offshore &lt;-<span class="st"> </span>comland.hakes[, <span class="kw">list</span>(YEAR, Half, AREA, MONTH, NEGEAR,
                                 TONCL1, NESPP3, UTILCD, MKTCAT, off.hake, 
                                 off.hake.value)]
offshore[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">507</span>]
<span class="kw">setnames</span>(offshore, <span class="kw">c</span>(<span class="st">&#39;off.hake&#39;</span>, <span class="st">&#39;off.hake.value&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
offshore &lt;-<span class="st"> </span>offshore[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]

<span class="co">#merge both and reformat for comland</span>
hakes.add.back &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(silver, offshore))

hakes.add.back[, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
<span class="kw">setcolorder</span>(hakes.add.back, <span class="kw">names</span>(comland))

comland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(comland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">507</span>, ], hakes.add.back))


<span class="co">#Herring---------------------------------------------------------------------------------</span>
<span class="co">#Herring data is housed by the state of Maine.</span>
herr.qry &lt;-<span class="st"> &quot;select year, month, stock_area, negear, gearname, keptmt, discmt</span>
<span class="st">             from maine_herring_catch&quot;</span>

herr.catch &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">sqlQuery</span>(channel, herr.qry))
<span class="kw">setkey</span>(herr.catch, YEAR, MONTH, STOCK_AREA, NEGEAR)

herring &lt;-<span class="st"> </span>herr.catch[, <span class="kw">list</span>(<span class="kw">sum</span>(KEPTMT), <span class="kw">sum</span>(DISCMT)), by =<span class="st"> </span><span class="kw">key</span>(herr.catch)]
<span class="kw">setnames</span>(herring, <span class="kw">c</span>(<span class="st">&#39;STOCK_AREA&#39;</span>, <span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>),
                  <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;DISCMT&#39;</span>))

<span class="co">#Using averages from comland to fill in categories</span>
herring[, MKTCAT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">5</span>]
herring[, TONCL1 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]
herring[, UTILCD <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

<span class="co">#compute price/utilization from CF tables</span>
herring.comland &lt;-<span class="st"> </span>comland[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">168</span>, ]
<span class="co">#Price from comland</span>
herring.price &lt;-<span class="st"> </span>herring.comland[, (<span class="kw">sum</span>(SPPVALUE) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT)), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>)]
<span class="kw">setnames</span>(herring.price, <span class="st">&#39;V1&#39;</span>, <span class="st">&#39;price&#39;</span>)
herring &lt;-<span class="st"> </span><span class="kw">merge</span>(herring, herring.price, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>), <span class="dt">all.x =</span> T)
<span class="co">#Use 1964 prices for &lt; 1964</span>
herring[YEAR <span class="op">&lt;</span><span class="st"> </span><span class="dv">1964</span>, price <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(herring[YEAR <span class="op">==</span><span class="st"> </span><span class="dv">1964</span>, price])]
<span class="co">#Calculate SPPVALUE from price</span>
herring[, SPPVALUE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">round</span>(price <span class="op">*</span><span class="st"> </span>SPPLIVMT)]

<span class="co">#Utilization from comland</span>
herring.util &lt;-<span class="st"> </span>herring.comland[, <span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
<span class="kw">setnames</span>(herring.util, <span class="st">&#39;V1&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>)
herring.util[, SPPLIVMT.ALL <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>)]
herring.util[, Prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT<span class="op">/</span>SPPLIVMT.ALL]
<span class="kw">setorder</span>(herring.util, YEAR, MONTH, Prop)
herring.util[, cum.prop <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">cumsum</span>(Prop), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>)]

<span class="co">#Apply proportions to Maine data set</span>
<span class="co">#Not pulled all the time - current through 2017</span>
herring[, Total <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>)]
herring[, Prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span>Total]
<span class="kw">setorder</span>(herring, YEAR, MONTH, Prop)
herring[, cum.prop <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">cumsum</span>(Prop), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;MONTH&#39;</span>)]

<span class="cf">for</span>(iyear <span class="cf">in</span> <span class="kw">unique</span>(herring.util[, YEAR])){
  <span class="cf">for</span>(imonth <span class="cf">in</span> <span class="kw">unique</span>(herring.util[YEAR <span class="op">==</span><span class="st"> </span>iyear, MONTH])){
    cum.prop.low &lt;-<span class="st"> </span><span class="dv">0</span>
    <span class="cf">for</span>(iutil <span class="cf">in</span> herring.util[YEAR <span class="op">==</span><span class="st"> </span>iyear <span class="op">&amp;</span><span class="st"> </span>MONTH <span class="op">==</span><span class="st"> </span>imonth, UTILCD]){
      cum.prop.high &lt;-<span class="st"> </span>herring.util[YEAR <span class="op">==</span><span class="st"> </span>iyear <span class="op">&amp;</span><span class="st"> </span>MONTH <span class="op">==</span><span class="st"> </span>imonth <span class="op">&amp;</span><span class="st"> </span>
<span class="st">                                      </span>UTILCD <span class="op">==</span><span class="st"> </span>iutil, cum.prop]
      herring[YEAR <span class="op">==</span><span class="st"> </span>iyear <span class="op">&amp;</span><span class="st"> </span>MONTH <span class="op">==</span><span class="st"> </span>imonth <span class="op">&amp;</span><span class="st"> </span>cum.prop <span class="op">&lt;=</span><span class="st"> </span>cum.prop.high <span class="op">&amp;</span>
<span class="st">                </span>cum.prop <span class="op">&gt;</span><span class="st"> </span>cum.prop.low, UTILCD <span class="op">:</span><span class="er">=</span><span class="st"> </span>iutil]
      cum.prop.low &lt;-<span class="st"> </span>cum.prop.high
    }
  }
}

<span class="co">#fix column headings</span>
herring[, <span class="kw">c</span>(<span class="st">&#39;Total&#39;</span>, <span class="st">&#39;Prop&#39;</span>, <span class="st">&#39;cum.prop&#39;</span>, <span class="st">&#39;price&#39;</span>, <span class="st">&#39;DISCMT&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
herring[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">168</span>]
<span class="kw">setcolorder</span>(herring, <span class="kw">names</span>(comland))

<span class="co">#remove herring from data pull and add in Maine numbers</span>
comland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(comland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">168</span>, ], herring))

<span class="co">#Menhaden------------------------------------------------------------------------------------</span>
##fix menhaden records - data from Tom Miller/ Andre Bouchheister
<span class="co">#menhaden &lt;- as.data.table(read.csv(paste(data.dir, &quot;Menhaden.csv&quot;, sep = &#39;&#39;)))</span>
<span class="co">#menhaden.mab &lt;- menhaden[, MA.Total + CB.Total, by = Year]</span>
##file metric is 1000s of lbs - convert to mt
<span class="co">#menhaden.mab[, SPPLIVMT := (V1 * 1000) *  0.00045359237]</span>
<span class="co">#menhaden.mab[, V1 := NULL]</span>
<span class="co">#</span>
<span class="co">#menhaden.gom &lt;- menhaden[, list(Year, NE.Total)]</span>
<span class="co">#menhaden.gom[, SPPLIVMT := (NE.Total * 1000) *  0.00045359237]</span>
<span class="co">#menhaden.gom[, NE.Total := NULL]</span>

<span class="co">#save(comland, file = paste(out.dir, &quot;Comland_unkA.RData&quot;, sep = &#39;&#39;))</span>

<span class="co">#Deal with unknowns-------------------------------------------------------------------------</span>
comland[NEGEAR <span class="op">==</span><span class="st"> </span><span class="dv">999</span>,  NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland[<span class="kw">is.na</span>(TONCL1),  TONCL1 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland[<span class="kw">is.na</span>(AREA),    AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(<span class="dv">0</span>)]
comland[AREA <span class="op">==</span><span class="st"> </span><span class="dv">999</span>,    AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(<span class="dv">0</span>)]
comland[<span class="kw">is.na</span>(MKTCAT),  MKTCAT <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
comland[<span class="kw">is.na</span>(UTILCD),  UTILCD <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

<span class="co">#1 - drop unknown species/landings</span>
comland &lt;-<span class="st"> </span>comland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>SPPLIVMT <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]

<span class="co">#Sumarry tables</span>
<span class="co">#missing area</span>
<span class="co">#known.area &lt;-   comland[AREA != 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#unknown.area &lt;- comland[AREA == 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#setnames(known.area,   &quot;V1&quot;, &quot;AREA.MT.known&quot;)</span>
<span class="co">#setnames(unknown.area, &quot;V1&quot;, &quot;AREA.MT.unknown&quot;)</span>
<span class="co">#missing.table &lt;- merge(known.area, unknown.area, by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#</span>
<span class="co">#missing.table[is.na(AREA.MT.known),   AREA.MT.known   := 0]</span>
<span class="co">#missing.table[is.na(AREA.MT.unknown), AREA.MT.unknown := 0]</span>
<span class="co">#missing.table[, AREA.Ratio := AREA.MT.unknown / AREA.MT.known]</span>
<span class="co">#</span>
##missing month
<span class="co">#known.month &lt;-   comland[MONTH != 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#unknown.month &lt;- comland[MONTH == 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#setnames(known.month,   &quot;V1&quot;, &quot;MONTH.MT.known&quot;)</span>
<span class="co">#setnames(unknown.month, &quot;V1&quot;, &quot;MONTH.MT.unknown&quot;)</span>
<span class="co">#missing.table &lt;- merge(missing.table, known.month,   by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#missing.table &lt;- merge(missing.table, unknown.month, by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#</span>
<span class="co">#missing.table[is.na(MONTH.MT.known),   MONTH.MT.known   := 0]</span>
<span class="co">#missing.table[is.na(MONTH.MT.unknown), MONTH.MT.unknown := 0]</span>
<span class="co">#missing.table[, MONTH.Ratio := MONTH.MT.unknown / MONTH.MT.known]</span>
<span class="co">#</span>
##missing gear
<span class="co">#known.gear &lt;-   comland[NEGEAR != 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#unknown.gear &lt;- comland[NEGEAR == 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#setnames(known.gear,   &quot;V1&quot;, &quot;GEAR.MT.known&quot;)</span>
<span class="co">#setnames(unknown.gear, &quot;V1&quot;, &quot;GEAR.MT.unknown&quot;)</span>
<span class="co">#missing.table &lt;- merge(missing.table, known.gear,   by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#missing.table &lt;- merge(missing.table, unknown.gear, by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#</span>
<span class="co">#missing.table[is.na(GEAR.MT.known),   GEAR.MT.known   := 0]</span>
<span class="co">#missing.table[is.na(GEAR.MT.unknown), GEAR.MT.unknown := 0]</span>
<span class="co">#missing.table[, GEAR.Ratio := GEAR.MT.unknown / GEAR.MT.known]</span>
<span class="co">#</span>
##missing tonnage class
<span class="co">#known.tc &lt;-   comland[TONCL1 != 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#unknown.tc &lt;- comland[TONCL1 == 0, sum(SPPLIVMT), by = NESPP3]</span>
<span class="co">#setnames(known.tc,   &quot;V1&quot;, &quot;TC.MT.known&quot;)</span>
<span class="co">#setnames(unknown.tc, &quot;V1&quot;, &quot;TC.MT.unknown&quot;)</span>
<span class="co">#missing.table &lt;- merge(missing.table, known.tc,   by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#missing.table &lt;- merge(missing.table, unknown.tc, by = &#39;NESPP3&#39;, all = T)</span>
<span class="co">#</span>
<span class="co">#missing.table[is.na(TC.MT.known),   TC.MT.known   := 0]</span>
<span class="co">#missing.table[is.na(TC.MT.unknown), TC.MT.unknown := 0]</span>
<span class="co">#missing.table[, TC.Ratio := TC.MT.unknown / TC.MT.known]</span>
<span class="co">#</span>
<span class="co">#write.csv(missing.table, paste(out.dir, &quot;\\Missing_table.csv&quot;, sep = &#39;&#39;), row.names = F)</span>
<span class="co">#</span>

<span class="co">#2 - aggregate by quarter year, half year, major gear, and small/large TC</span>
comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">4</span><span class="op">:</span><span class="dv">6</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]
comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">9</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">3</span>]
comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">10</span><span class="op">:</span><span class="dv">12</span>, QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">4</span>]
comland[MONTH <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,       QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">6</span>,  HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
comland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">12</span>, HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]
comland[MONTH <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,      HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

otter     &lt;-<span class="st"> </span><span class="dv">50</span><span class="op">:</span><span class="dv">59</span>
dredge.sc &lt;-<span class="st"> </span><span class="dv">131</span><span class="op">:</span><span class="dv">132</span>
pot       &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">189</span><span class="op">:</span><span class="dv">190</span>, <span class="dv">200</span><span class="op">:</span><span class="dv">219</span>, <span class="dv">300</span>, <span class="dv">301</span>)
longline  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">40</span>)
seine     &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">70</span><span class="op">:</span><span class="dv">79</span>, <span class="dv">120</span><span class="op">:</span><span class="dv">129</span>, <span class="dv">360</span>)
gillnet   &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">100</span><span class="op">:</span><span class="dv">119</span>, <span class="dv">500</span>, <span class="dv">510</span>, <span class="dv">520</span>)
midwater  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">170</span>, <span class="dv">370</span>)
dredge.o  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">281</span>, <span class="dv">282</span>, <span class="dv">380</span><span class="op">:</span><span class="dv">400</span>)

comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>otter,     GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;otter&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>dredge.sc, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;dredge.sc&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>pot,       GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;pot&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>longline,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;longline&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>seine,     GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;seine&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>gillnet,   GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;gillnet&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>midwater,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;midwater&#39;</span>]
comland[NEGEAR <span class="op">%in%</span><span class="st"> </span>dredge.o,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;dredge.o&#39;</span>]
comland[NEGEAR <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,           GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;unknown&#39;</span>]
comland[<span class="kw">is.na</span>(GEAR),           GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;other&#39;</span>]
comland[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(GEAR)]

comland[TONCL1 <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;small&#39;</span>]
comland[TONCL1 <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>,      SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;large&#39;</span>]
comland[TONCL1 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,     SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;unknown&#39;</span>]
comland[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(SIZE)]

<span class="kw">setkey</span>(comland,
       YEAR,
       QY,
       HY,
       GEAR,
       SIZE,
       AREA,
       NESPP3,
       UTILCD)

comland.agg &lt;-<span class="st"> </span>comland[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), by =<span class="st"> </span><span class="kw">key</span>(comland)]

<span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))

<span class="co">#3 - Use proportions of known catch to assign unknown catch</span>
<span class="co">#3.A QY/HY------------------------------------------------------------------------------</span>
  unk.month &lt;-<span class="st"> </span>comland.agg[QY <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  k.month   &lt;-<span class="st"> </span>comland.agg[QY <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="co">#3.A.1 - All match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.month.all &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.all &lt;-<span class="st"> </span>unk.month.all[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.all &lt;-<span class="st"> </span>unk.month.all[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  k.month.all &lt;-<span class="st"> </span>k.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.all &lt;-<span class="st"> </span>k.month.all[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.all &lt;-<span class="st"> </span>k.month.all[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="kw">setkeyv</span>(unk.month.all, match.key)
  <span class="kw">setkeyv</span>(k.month.all,   match.key)
  
  month.all &lt;-<span class="st"> </span>k.month.all[unk.month.all]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.all[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, AREA, GEAR)
  <span class="kw">setkeyv</span>(k.month.all, <span class="kw">key</span>(no.match))
  month.all.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.all[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.all.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.month.all, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  month.all.<span class="dv">3</span> &lt;-<span class="st"> </span>k.month.all[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>month.all.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.all, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  month.all.<span class="dv">4</span> &lt;-<span class="st"> </span>k.month.all[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>month.all.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, 
                         <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.all   &lt;-<span class="st"> </span>month.all  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.all.<span class="dv">2</span> &lt;-<span class="st"> </span>month.all.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.all.<span class="dv">2</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  month.all.<span class="dv">2</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(month.all.<span class="dv">2</span>, <span class="kw">names</span>(month.all))
  month.all.<span class="dv">3</span> &lt;-<span class="st"> </span>month.all.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.all.<span class="dv">3</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  month.all.<span class="dv">3</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  month.all.<span class="dv">3</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  month.all.<span class="dv">3</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(month.all.<span class="dv">3</span>, <span class="kw">names</span>(month.all))
  month.all.<span class="dv">4</span> &lt;-<span class="st"> </span>month.all.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.all.<span class="dv">4</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
  month.all.<span class="dv">4</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  month.all.<span class="dv">4</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  month.all.<span class="dv">4</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  month.all.<span class="dv">4</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  month.all.<span class="dv">4</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(month.all.<span class="dv">4</span>, <span class="kw">names</span>(month.all))
  
  month.all &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.all, month.all.<span class="dv">2</span>, month.all.<span class="dv">3</span>, month.all.<span class="dv">4</span>))
  
  month.all[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.all[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.all[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.all[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, 
                <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.all, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setcolorder</span>(no.match.<span class="dv">4</span>, <span class="kw">names</span>(month.all))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.all, no.match.<span class="dv">4</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.all&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.A.2 - GEAR/SIZE</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>)
  
  unk.month.g.s &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.g.s &lt;-<span class="st"> </span>unk.month.g.s[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.g.s &lt;-<span class="st"> </span>unk.month.g.s[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.g.s &lt;-<span class="st"> </span>unk.month.g.s[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                                 by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.g.s, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.g.s &lt;-<span class="st"> </span>k.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.g.s &lt;-<span class="st"> </span>k.month.g.s[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.g.s &lt;-<span class="st"> </span>k.month.g.s[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.g.s, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.g.s, match.key)
  <span class="kw">setkeyv</span>(k.month.g.s,   match.key)
  
  month.g.s &lt;-<span class="st"> </span>k.month.g.s[unk.month.g.s]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.g.s[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, GEAR)
  <span class="kw">setkeyv</span>(k.month.g.s, <span class="kw">key</span>(no.match))
  month.g.s.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.g.s[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.g.s.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.g.s, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  month.g.s.<span class="dv">3</span> &lt;-<span class="st"> </span>k.month.g.s[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>month.g.s.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">3</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.g.s   &lt;-<span class="st"> </span>month.g.s  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.g.s.<span class="dv">2</span> &lt;-<span class="st"> </span>month.g.s.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.g.s.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.g.s.<span class="dv">2</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
    month.g.s.<span class="dv">2</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.g.s.<span class="dv">2</span>, <span class="kw">names</span>(month.g.s))
    month.g.s &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.g.s, month.g.s.<span class="dv">2</span>))  
  }
  month.g.s.<span class="dv">3</span> &lt;-<span class="st"> </span>month.g.s.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.g.s.<span class="dv">3</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.g.s.<span class="dv">3</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
    month.g.s.<span class="dv">3</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
    month.g.s.<span class="dv">3</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    month.g.s.<span class="dv">3</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.g.s.<span class="dv">3</span>, <span class="kw">names</span>(month.g.s))
    month.g.s &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.g.s, month.g.s.<span class="dv">3</span>))
  }
  
  month.g.s[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.g.s[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.g.s[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.g.s[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, 
                <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.g.s, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.g.s[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="kw">setcolorder</span>(month.g.s,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">3</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.g.s, no.match.<span class="dv">3</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.g.s&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.A.3 - AREA/GEAR</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.month.a.g &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.a.g &lt;-<span class="st"> </span>unk.month.a.g[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.a.g &lt;-<span class="st"> </span>unk.month.a.g[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.a.g &lt;-<span class="st"> </span>unk.month.a.g[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                                 by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.a.g, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.a.g &lt;-<span class="st"> </span>k.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.a.g &lt;-<span class="st"> </span>k.month.a.g[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  k.month.a.g &lt;-<span class="st"> </span>k.month.a.g[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.a.g, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.a.g, match.key)
  <span class="kw">setkeyv</span>(k.month.a.g,   match.key)
  
  month.a.g &lt;-<span class="st"> </span>k.month.a.g[unk.month.a.g]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.a.g[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.month.a.g, <span class="kw">key</span>(no.match))
  month.a.g.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.a.g[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.g.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.a.g, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  month.a.g.<span class="dv">3</span> &lt;-<span class="st"> </span>k.month.a.g[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>month.a.g.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">3</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.a.g   &lt;-<span class="st"> </span>month.a.g  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.a.g.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.g.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.a.g.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.a.g.<span class="dv">2</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
    month.a.g.<span class="dv">2</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.a.g.<span class="dv">2</span>, <span class="kw">names</span>(month.a.g))
    month.a.g &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.a.g, month.a.g.<span class="dv">2</span>))  
  }
  month.a.g.<span class="dv">3</span> &lt;-<span class="st"> </span>month.a.g.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.a.g.<span class="dv">3</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.a.g.<span class="dv">3</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
    month.a.g.<span class="dv">3</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
    month.a.g.<span class="dv">3</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    month.a.g.<span class="dv">3</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.a.g.<span class="dv">3</span>, <span class="kw">names</span>(month.a.g))
    month.a.g &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.a.g, month.a.g.<span class="dv">3</span>))  
  }
  
  month.a.g[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.a.g[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.a.g[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.a.g[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, 
                <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.a.g, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.a.g[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
 
 <span class="kw">setcolorder</span>(month.a.g,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">3</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.a.g, no.match.<span class="dv">3</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.a.g&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.A.4 - AREA/TC</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.month.a.s &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.a.s &lt;-<span class="st"> </span>unk.month.a.s[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.a.s &lt;-<span class="st"> </span>unk.month.a.s[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.a.s &lt;-<span class="st"> </span>unk.month.a.s[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                                 by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.a.s, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.a.s &lt;-<span class="st"> </span>k.month[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.a.s &lt;-<span class="st"> </span>k.month.a.s[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  k.month.a.s &lt;-<span class="st"> </span>k.month.a.s[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.a.s, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.a.s, match.key)
  <span class="kw">setkeyv</span>(k.month.a.s,   match.key)
  
  month.a.s &lt;-<span class="st"> </span>k.month.a.s[unk.month.a.s]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.a.s[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.month.a.s, <span class="kw">key</span>(no.match))
  month.a.s.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.a.s[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.s.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.a.s, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  month.a.s.<span class="dv">3</span> &lt;-<span class="st"> </span>k.month.a.s[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>month.a.s.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">3</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.a.s   &lt;-<span class="st"> </span>month.a.s  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.a.s.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.s.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.a.s.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.a.s.<span class="dv">2</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
    month.a.s.<span class="dv">2</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.a.s.<span class="dv">2</span>, <span class="kw">names</span>(month.a.s))
    month.a.s &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.a.s, month.a.s.<span class="dv">2</span>))
  }
  month.a.s.<span class="dv">3</span> &lt;-<span class="st"> </span>month.a.s.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.a.s.<span class="dv">3</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.a.s.<span class="dv">3</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
    month.a.s.<span class="dv">3</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
    month.a.s.<span class="dv">3</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    month.a.s.<span class="dv">3</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.a.s.<span class="dv">3</span>, <span class="kw">names</span>(month.a.s))
    month.a.s &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.a.s, month.a.s.<span class="dv">3</span>))  
  }
  
  month.a.s[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.a.s[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.a.s[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.a.s[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, 
                <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.a.s, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.a.s[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="kw">setcolorder</span>(month.a.s,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">3</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.a.s, no.match.<span class="dv">3</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.a.s&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))

<span class="co">#3.A.5 - SIZE</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;SIZE&#39;</span>)
  
  unk.month.si &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.si &lt;-<span class="st"> </span>unk.month.si[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.si &lt;-<span class="st"> </span>unk.month.si[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.si &lt;-<span class="st"> </span>unk.month.si[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                               by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.si, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.si &lt;-<span class="st"> </span>k.month[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.si &lt;-<span class="st"> </span>k.month.si[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                           by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.si, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.si, match.key)
  <span class="kw">setkeyv</span>(k.month.si,   match.key)
  
  month.si &lt;-<span class="st"> </span>k.month.si[unk.month.si]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.si[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.si, <span class="kw">key</span>(no.match))
  month.si.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.si[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.si.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">2</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  no.match.<span class="dv">2</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.si   &lt;-<span class="st"> </span>month.si  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.si.<span class="dv">2</span> &lt;-<span class="st"> </span>month.si.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.si.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.si.<span class="dv">2</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
    month.si.<span class="dv">2</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.si.<span class="dv">2</span>, <span class="kw">names</span>(month.si))
    month.si &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.si, month.si.<span class="dv">2</span>))
    }
   
  month.si[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.si[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.si[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.si[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, 
               <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.si, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.si[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  month.si[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="kw">setcolorder</span>(month.si,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">2</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.si, no.match.<span class="dv">2</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.si&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.A.6 - GEAR</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;GEAR&#39;</span>)
  
  unk.month.g &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.g &lt;-<span class="st"> </span>unk.month.g[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.g &lt;-<span class="st"> </span>unk.month.g[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.g &lt;-<span class="st"> </span>unk.month.g[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.g, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.g &lt;-<span class="st"> </span>k.month[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.month.g &lt;-<span class="st"> </span>k.month.g[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                         by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.g, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.g, match.key)
  <span class="kw">setkeyv</span>(k.month.g,   match.key)
  
  month.g &lt;-<span class="st"> </span>k.month.g[unk.month.g]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.g[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.g, <span class="kw">key</span>(no.match))
  month.g.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.g[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.g.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">2</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  no.match.<span class="dv">2</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.g   &lt;-<span class="st"> </span>month.g  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.g.<span class="dv">2</span> &lt;-<span class="st"> </span>month.g.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.g.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.g.<span class="dv">2</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
    month.g.<span class="dv">2</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.g.<span class="dv">2</span>, <span class="kw">names</span>(month.g))
    month.g &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.g, month.g.<span class="dv">2</span>))
    }
  
  month.g[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.g[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.g[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.g[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, 
              <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.g, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>, <span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.g[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  month.g[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="kw">setcolorder</span>(month.g,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">2</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.g, no.match.<span class="dv">2</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.g&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.A.7 - AREA</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.month.a &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.a &lt;-<span class="st"> </span>unk.month.a[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.a &lt;-<span class="st"> </span>unk.month.a[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.a &lt;-<span class="st"> </span>unk.month.a[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.a, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.a &lt;-<span class="st"> </span>k.month[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  k.month.a &lt;-<span class="st"> </span>k.month.a[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                         by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.a, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.a, match.key)
  <span class="kw">setkeyv</span>(k.month.a,   match.key)
  
  month.a &lt;-<span class="st"> </span>k.month.a[unk.month.a]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>month.a[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.month.a, <span class="kw">key</span>(no.match))
  month.a.<span class="dv">2</span> &lt;-<span class="st"> </span>k.month.a[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to first QY/HY</span>
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match.<span class="dv">2</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  no.match.<span class="dv">2</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="co">#Merge all together and proportion catch to known months</span>
  month.a   &lt;-<span class="st"> </span>month.a  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  month.a.<span class="dv">2</span> &lt;-<span class="st"> </span>month.a.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="cf">if</span>(<span class="kw">nrow</span>(month.a.<span class="dv">2</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>){
    month.a.<span class="dv">2</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
    month.a.<span class="dv">2</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setcolorder</span>(month.a.<span class="dv">2</span>, <span class="kw">names</span>(month.a))
    month.a &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.a, month.a.<span class="dv">2</span>))
    }
  
  month.a[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.a[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.a[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.a[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, 
              <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.a, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.a[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  month.a[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  
  <span class="kw">setcolorder</span>(month.a,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">2</span>, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.a, no.match.<span class="dv">2</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.a&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
    
  <span class="co">#3.A.8 - Species only - no other match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>)
  
  unk.month.sp &lt;-<span class="st"> </span>unk.month[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.month.sp &lt;-<span class="st"> </span>unk.month.sp[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.month.sp &lt;-<span class="st"> </span>unk.month.sp[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.month.sp &lt;-<span class="st"> </span>unk.month.sp[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                               by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(unk.month.sp, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  k.month.sp &lt;-<span class="st"> </span>k.month[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                        by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.month.sp, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.month.sp, match.key)
  <span class="kw">setkeyv</span>(k.month.sp,   match.key)
  
  month.sp &lt;-<span class="st"> </span>k.month.sp[unk.month.sp]
  
  <span class="co">#No match - assign to first QY/HY</span>
  no.match  &lt;-<span class="st"> </span>month.sp[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  no.match[, <span class="kw">c</span>(<span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  no.match[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  no.match[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  no.match[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  
  <span class="co">#proportion catch to known months</span>
  month.sp   &lt;-<span class="st"> </span>month.sp  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  
  month.sp[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  month.sp[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  month.sp[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  month.sp[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, 
               <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(month.sp, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  month.sp[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  month.sp[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.month[, GEAR]))]
  month.sp[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  
  <span class="kw">setcolorder</span>(month.sp,  <span class="kw">names</span>(month.solved))
  <span class="kw">setcolorder</span>(no.match, <span class="kw">names</span>(month.solved))
  month.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(month.solved, month.sp, no.match))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;month.sp&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#Merge back month.solved</span>
  <span class="kw">setcolorder</span>(month.solved, <span class="kw">names</span>(comland.agg))
  comland.agg &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(k.month, month.solved))
  <span class="kw">setkey</span>(comland.agg,
         YEAR,
         QY,
         HY,
         SIZE,
         GEAR,
         AREA,
         NESPP3,
         UTILCD)
  comland.agg &lt;-<span class="st"> </span>comland.agg[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">key</span>(comland.agg)]
  <span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))

<span class="co">#3.B SIZE------------------------------------------------------------------------------</span>
  unk.size &lt;-<span class="st"> </span>comland.agg[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.size   &lt;-<span class="st"> </span>comland.agg[SIZE <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  
  <span class="co">#3.B.1 - All match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.size.all &lt;-<span class="st"> </span>unk.size[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.size.all &lt;-<span class="st"> </span>unk.size.all[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  k.size.all &lt;-<span class="st"> </span>k.size[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.size.all &lt;-<span class="st"> </span>k.size.all[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="kw">setkeyv</span>(unk.size.all, match.key)
  <span class="kw">setkeyv</span>(k.size.all,   match.key)
  
  size.all &lt;-<span class="st"> </span>k.size.all[unk.size.all]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>size.all[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, GEAR, AREA)
  <span class="kw">setkeyv</span>(k.size.all, <span class="kw">key</span>(no.match))
  size.all.<span class="dv">2</span> &lt;-<span class="st"> </span>k.size.all[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>size.all.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, GEAR, AREA)
  <span class="kw">setkeyv</span>(k.size.all, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  size.all.<span class="dv">3</span> &lt;-<span class="st"> </span>k.size.all[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>size.all.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.size.all, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  size.all.<span class="dv">4</span> &lt;-<span class="st"> </span>k.size.all[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>size.all.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">4</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.size.all, <span class="kw">key</span>(no.match.<span class="dv">4</span>))
  size.all.<span class="dv">5</span> &lt;-<span class="st"> </span>k.size.all[no.match.<span class="dv">4</span>]
  no.match.<span class="dv">5</span> &lt;-<span class="st"> </span>size.all.<span class="dv">5</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">5</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">5</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>,   <span class="st">&#39;GEAR&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to SIZE to small</span>
  no.match.<span class="dv">5</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;small&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="co">#Merge all together and proportion catch to known sizes</span>
  size.all   &lt;-<span class="st"> </span>size.all  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.all.<span class="dv">2</span> &lt;-<span class="st"> </span>size.all.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.all.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.all.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.all.<span class="dv">2</span>, <span class="kw">names</span>(size.all))
  size.all.<span class="dv">3</span> &lt;-<span class="st"> </span>size.all.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.all.<span class="dv">3</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.all.<span class="dv">3</span>[, HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.all.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.all.<span class="dv">3</span>, <span class="kw">names</span>(size.all))
  size.all.<span class="dv">4</span> &lt;-<span class="st"> </span>size.all.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.all.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.all.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.all.<span class="dv">4</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  size.all.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">4</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.all.<span class="dv">4</span>, <span class="kw">names</span>(size.all))
  size.all.<span class="dv">5</span> &lt;-<span class="st"> </span>size.all.<span class="dv">5</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.all.<span class="dv">5</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.all.<span class="dv">5</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.all.<span class="dv">5</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  size.all.<span class="dv">5</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
  size.all.<span class="dv">5</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">5</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">5</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.all.<span class="dv">5</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.all.<span class="dv">5</span>, <span class="kw">names</span>(size.all))
  
  size.all &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.all, size.all.<span class="dv">2</span>, size.all.<span class="dv">3</span>, 
                             size.all.<span class="dv">4</span>, size.all.<span class="dv">5</span>))
  
  size.all[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  size.all[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  size.all[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  size.all[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, 
               <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(size.all, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setcolorder</span>(no.match.<span class="dv">5</span>, <span class="kw">names</span>(size.all))
  size.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.all, no.match.<span class="dv">5</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;size.all&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.B.2 - GEAR</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;GEAR&#39;</span>)
  
  unk.size.g &lt;-<span class="st"> </span>unk.size[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>]
  unk.size.g &lt;-<span class="st"> </span>unk.size.g[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.size.g[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  k.size.g &lt;-<span class="st"> </span>k.size[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.size.g &lt;-<span class="st"> </span>k.size.g[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                       by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.size.g, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.size.g, match.key)
  <span class="kw">setkeyv</span>(k.size.g,   match.key)
  
  size.g &lt;-<span class="st"> </span>k.size.g[unk.size.g]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>size.g[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, GEAR)
  <span class="kw">setkeyv</span>(k.size.g, <span class="kw">key</span>(no.match))
  size.g.<span class="dv">2</span> &lt;-<span class="st"> </span>k.size.g[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>size.g.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, GEAR)
  <span class="kw">setkeyv</span>(k.size.g, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  size.g.<span class="dv">3</span> &lt;-<span class="st"> </span>k.size.g[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>size.g.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.size.g, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  size.g.<span class="dv">4</span> &lt;-<span class="st"> </span>k.size.g[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>size.g.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to SIZE to small</span>
  no.match.<span class="dv">4</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;small&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  no.match.<span class="dv">4</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge all together and proportion catch to known sizes</span>
  size.g   &lt;-<span class="st"> </span>size.g  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.g.<span class="dv">2</span> &lt;-<span class="st"> </span>size.g.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.g.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.g.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.g.<span class="dv">2</span>, <span class="kw">names</span>(size.g))
  size.g.<span class="dv">3</span> &lt;-<span class="st"> </span>size.g.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.g.<span class="dv">3</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.g.<span class="dv">3</span>[, HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.g.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.g.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.g.<span class="dv">3</span>, <span class="kw">names</span>(size.g))
  size.g.<span class="dv">4</span> &lt;-<span class="st"> </span>size.g.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.g.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.g.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.g.<span class="dv">4</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  size.g.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.g.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.g.<span class="dv">4</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.g.<span class="dv">4</span>, <span class="kw">names</span>(size.g))
  
  size.g &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.g, size.g.<span class="dv">2</span>, size.g.<span class="dv">3</span>, size.g.<span class="dv">4</span>))
  
  size.g[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  size.g[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  size.g[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  size.g[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, 
             <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(size.g, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  size.g[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="kw">setcolorder</span>(size.g,     <span class="kw">names</span>(size.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">4</span>, <span class="kw">names</span>(size.g))
  size.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.solved, size.g, no.match.<span class="dv">4</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;size.g&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))         

  <span class="co">#3.B.3 - AREA</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.size.a &lt;-<span class="st"> </span>unk.size[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.size.a &lt;-<span class="st"> </span>unk.size.a[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.size.a[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  k.size.a &lt;-<span class="st"> </span>k.size[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  k.size.a &lt;-<span class="st"> </span>k.size.a[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                       by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.size.a, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.size.a, match.key)
  <span class="kw">setkeyv</span>(k.size.a,   match.key)
  
  size.a &lt;-<span class="st"> </span>k.size.a[unk.size.a]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>size.a[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, AREA)
  <span class="kw">setkeyv</span>(k.size.a, <span class="kw">key</span>(no.match))
  size.a.<span class="dv">2</span> &lt;-<span class="st"> </span>k.size.a[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>size.a.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.size.a, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  size.a.<span class="dv">3</span> &lt;-<span class="st"> </span>k.size.a[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>size.a.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.size.a, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  size.a.<span class="dv">4</span> &lt;-<span class="st"> </span>k.size.a[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>size.a.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to SIZE to small</span>
  no.match.<span class="dv">4</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;small&#39;</span>,   <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  no.match.<span class="dv">4</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.size[, GEAR]))]
  
  <span class="co">#Merge all together and proportion catch to known sizes</span>
  size.a   &lt;-<span class="st"> </span>size.a  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.a.<span class="dv">2</span> &lt;-<span class="st"> </span>size.a.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.a.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.a.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.a.<span class="dv">2</span>, <span class="kw">names</span>(size.a))
  size.a.<span class="dv">3</span> &lt;-<span class="st"> </span>size.a.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.a.<span class="dv">3</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.a.<span class="dv">3</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.a.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.a.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.a.<span class="dv">3</span>, <span class="kw">names</span>(size.a))
  size.a.<span class="dv">4</span> &lt;-<span class="st"> </span>size.a.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.a.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.a.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.a.<span class="dv">4</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
  size.a.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.a.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.a.<span class="dv">4</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.a.<span class="dv">4</span>, <span class="kw">names</span>(size.a))
  
  size.a &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.a, size.a.<span class="dv">2</span>, size.a.<span class="dv">3</span>, size.a.<span class="dv">4</span>))
  
  size.a[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  size.a[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  size.a[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  size.a[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, 
             <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(size.a, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  size.a[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.size[, GEAR]))]
  
  <span class="kw">setcolorder</span>(size.a,     <span class="kw">names</span>(size.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">4</span>, <span class="kw">names</span>(size.a))
  size.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.solved, size.a, no.match.<span class="dv">4</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;size.a&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))         
  
  <span class="co">#3.B.4 - Species only - no other match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>)
  
  unk.size.sp &lt;-<span class="st"> </span>unk.size[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>]
  unk.size.sp &lt;-<span class="st"> </span>unk.size.sp[SIZE <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  unk.size.sp &lt;-<span class="st"> </span>unk.size.sp[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.size.sp[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;AREA&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  k.size.sp &lt;-<span class="st"> </span>k.size[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                      by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.size.sp, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.size.sp, match.key)
  <span class="kw">setkeyv</span>(k.size.sp,   match.key)
  
  size.sp &lt;-<span class="st"> </span>k.size.sp[unk.size.sp]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>size.sp[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY)
  <span class="kw">setkeyv</span>(k.size.sp, <span class="kw">key</span>(no.match))
  size.sp.<span class="dv">2</span> &lt;-<span class="st"> </span>k.size.sp[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>size.sp.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.size.sp, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  size.sp.<span class="dv">3</span> &lt;-<span class="st"> </span>k.size.sp[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>size.sp.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to SIZE to small</span>
  no.match.<span class="dv">3</span>[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;small&#39;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;large&#39;</span>, <span class="st">&#39;small&#39;</span>, <span class="st">&#39;unknown&#39;</span>))]
  no.match.<span class="dv">3</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.size[, GEAR]))]
  no.match.<span class="dv">3</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge together and proportion catch to known sizes</span>
  size.sp   &lt;-<span class="st"> </span>size.sp  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.sp.<span class="dv">2</span> &lt;-<span class="st"> </span>size.sp.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.sp.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.sp.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.sp.<span class="dv">2</span>, <span class="kw">names</span>(size.sp))
  size.sp.<span class="dv">3</span> &lt;-<span class="st"> </span>size.sp.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  size.sp.<span class="dv">3</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  size.sp.<span class="dv">3</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  size.sp.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  size.sp.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(size.sp.<span class="dv">3</span>, <span class="kw">names</span>(size.sp))
  
  size.sp &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.sp, size.sp.<span class="dv">2</span>, size.sp.<span class="dv">3</span>))
  
  size.sp[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  size.sp[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  size.sp[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  size.sp[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, 
              <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(size.sp, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  size.sp[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  size.sp[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;unknown&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.size[, GEAR]))]
  
  <span class="kw">setcolorder</span>(size.sp,    <span class="kw">names</span>(size.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">3</span>, <span class="kw">names</span>(size.solved))
  size.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(size.solved, size.sp, no.match.<span class="dv">3</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;size.sp&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#Merge back size.solved</span>
  <span class="kw">setcolorder</span>(size.solved, <span class="kw">names</span>(comland.agg))
  comland.agg &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(k.size, size.solved))
  <span class="kw">setkey</span>(comland.agg,
         YEAR,
         QY,
         HY,
         SIZE,
         GEAR,
         AREA,
         NESPP3,
         UTILCD)
  comland.agg &lt;-<span class="st"> </span>comland.agg[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">key</span>(comland.agg)]
  <span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
<span class="co">#3.C GEAR------------------------------------------------------------------------------</span>
  unk.gear &lt;-<span class="st"> </span>comland.agg[GEAR <span class="op">==</span><span class="st"> &#39;unknown&#39;</span>, ]
  k.gear   &lt;-<span class="st"> </span>comland.agg[GEAR <span class="op">!=</span><span class="st"> &#39;unknown&#39;</span>, ]
  
  <span class="co">#3.C.1 - All match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;AREA&#39;</span>)
  
  unk.gear.all &lt;-<span class="st"> </span>unk.gear[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  k.gear.all &lt;-<span class="st"> </span>k.gear[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="kw">setkeyv</span>(unk.gear.all, match.key)
  <span class="kw">setkeyv</span>(k.gear.all,   match.key)
  
  gear.all &lt;-<span class="st"> </span>k.gear.all[unk.gear.all]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>gear.all[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, SIZE, AREA)
  <span class="kw">setkeyv</span>(k.gear.all, <span class="kw">key</span>(no.match))
  gear.all.<span class="dv">2</span> &lt;-<span class="st"> </span>k.gear.all[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, SIZE, AREA)
  <span class="kw">setkeyv</span>(k.gear.all, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  gear.all.<span class="dv">3</span> &lt;-<span class="st"> </span>k.gear.all[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3, AREA)
  <span class="kw">setkeyv</span>(k.gear.all, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  gear.all.<span class="dv">4</span> &lt;-<span class="st"> </span>k.gear.all[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop AREA</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">4</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.gear.all, <span class="kw">key</span>(no.match.<span class="dv">4</span>))
  gear.all.<span class="dv">5</span> &lt;-<span class="st"> </span>k.gear.all[no.match.<span class="dv">4</span>]
  no.match.<span class="dv">5</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">5</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">5</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">5</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>,
                         <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to GEAR to other</span>
  no.match.<span class="dv">5</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;other&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.gear[, GEAR]))]
  
  <span class="co">#Merge all together and proportion catch to known gears</span>
  gear.all   &lt;-<span class="st"> </span>gear.all  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.all.<span class="dv">2</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.all.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.all.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.all.<span class="dv">2</span>, <span class="kw">names</span>(gear.all))
  gear.all.<span class="dv">3</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.all.<span class="dv">3</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.all.<span class="dv">3</span>[, HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  gear.all.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.all.<span class="dv">3</span>, <span class="kw">names</span>(gear.all))
  gear.all.<span class="dv">4</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.all.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.all.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  gear.all.<span class="dv">4</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  gear.all.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">4</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.all.<span class="dv">4</span>, <span class="kw">names</span>(gear.all))
  gear.all.<span class="dv">5</span> &lt;-<span class="st"> </span>gear.all.<span class="dv">5</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.all.<span class="dv">5</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.all.<span class="dv">5</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  gear.all.<span class="dv">5</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  gear.all.<span class="dv">5</span>[, AREA   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.AREA]
  gear.all.<span class="dv">5</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">5</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">5</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.all.<span class="dv">5</span>[, i.AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.all.<span class="dv">5</span>, <span class="kw">names</span>(gear.all))
  
  gear.all &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(gear.all, gear.all.<span class="dv">2</span>, gear.all.<span class="dv">3</span>, 
                             gear.all.<span class="dv">4</span>, gear.all.<span class="dv">5</span>))
  
  gear.all[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  gear.all[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  gear.all[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  gear.all[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, 
               <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(gear.all, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setcolorder</span>(no.match.<span class="dv">5</span>, <span class="kw">names</span>(gear.all))
  gear.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(gear.all, no.match.<span class="dv">5</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;gear.all&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#3.C.2 - Species only - no other match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;SIZE&#39;</span>)
  
  unk.gear.sp &lt;-<span class="st"> </span>unk.gear[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  unk.gear.sp[, <span class="st">&#39;AREA&#39;</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  k.gear.sp &lt;-<span class="st"> </span>k.gear[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                      by =<span class="st"> </span><span class="kw">c</span>(match.key, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.gear.sp, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setkeyv</span>(unk.gear.sp, match.key)
  <span class="kw">setkeyv</span>(k.gear.sp,   match.key)
  
  gear.sp &lt;-<span class="st"> </span>k.gear.sp[unk.gear.sp]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>gear.sp[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, SIZE)
  <span class="kw">setkeyv</span>(k.gear.sp, <span class="kw">key</span>(no.match))
  gear.sp.<span class="dv">2</span> &lt;-<span class="st"> </span>k.gear.sp[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, SIZE)
  <span class="kw">setkeyv</span>(k.gear.sp, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  gear.sp.<span class="dv">3</span> &lt;-<span class="st"> </span>k.gear.sp[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.gear.sp, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  gear.sp.<span class="dv">4</span> &lt;-<span class="st"> </span>k.gear.sp[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;GEAR&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - assign to GEAR to other</span>
  no.match.<span class="dv">4</span>[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">&#39;other&#39;</span>, <span class="dt">levels =</span> <span class="kw">levels</span>(k.gear[, GEAR]))]
  no.match.<span class="dv">4</span>[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge all together and proportion catch to known gears</span>
  gear.sp   &lt;-<span class="st"> </span>gear.sp  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.sp.<span class="dv">2</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.sp.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.sp.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.sp.<span class="dv">2</span>, <span class="kw">names</span>(gear.sp))
  gear.sp.<span class="dv">3</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.sp.<span class="dv">3</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.sp.<span class="dv">3</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  gear.sp.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.sp.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.sp.<span class="dv">3</span>, <span class="kw">names</span>(gear.sp))
  gear.sp.<span class="dv">4</span> &lt;-<span class="st"> </span>gear.sp.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  gear.sp.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  gear.sp.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  gear.sp.<span class="dv">4</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  gear.sp.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.sp.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  gear.sp.<span class="dv">4</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(gear.sp.<span class="dv">4</span>, <span class="kw">names</span>(gear.sp))
  
  gear.sp &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(gear.sp, gear.sp.<span class="dv">2</span>, gear.sp.<span class="dv">3</span>, gear.sp.<span class="dv">4</span>))
  
  gear.sp[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  gear.sp[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  gear.sp[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  gear.sp[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, 
              <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(gear.sp, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  gear.sp[, AREA <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="kw">setcolorder</span>(gear.sp,    <span class="kw">names</span>(gear.solved))
  <span class="kw">setcolorder</span>(no.match.<span class="dv">4</span>, <span class="kw">names</span>(gear.solved))
  gear.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(gear.solved, gear.sp, no.match.<span class="dv">4</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;gear.sp&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#Merge back gear.solved</span>
  <span class="kw">setcolorder</span>(gear.solved, <span class="kw">names</span>(comland.agg))
  comland.agg &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(k.gear, gear.solved))
  <span class="kw">setkey</span>(comland.agg,
         YEAR,
         QY,
         HY,
         SIZE,
         GEAR,
         AREA,
         NESPP3,
         UTILCD)
  comland.agg &lt;-<span class="st"> </span>comland.agg[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">key</span>(comland.agg)]
  <span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    
<span class="co">#3.D AREA------------------------------------------------------------------------------</span>
  unk.area &lt;-<span class="st"> </span>comland.agg[AREA <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, ]
  k.area   &lt;-<span class="st"> </span>comland.agg[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="co">#3.C.1 - All match</span>
  match.key &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;GEAR&#39;</span>)
  
  unk.area.all &lt;-<span class="st"> </span>unk.area
  
  k.area.all &lt;-<span class="st"> </span>k.area
  
  <span class="kw">setkeyv</span>(unk.area.all, match.key)
  <span class="kw">setkeyv</span>(k.area.all,   match.key)
  
  area.all &lt;-<span class="st"> </span>k.area.all[unk.area.all]
  
  <span class="co">#No match - need to match with larger aggregation</span>
  no.match  &lt;-<span class="st"> </span>area.all[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop QY</span>
  <span class="kw">setkey</span>(no.match, YEAR, NESPP3, HY, SIZE, GEAR)
  <span class="kw">setkeyv</span>(k.area.all, <span class="kw">key</span>(no.match))
  area.all.<span class="dv">2</span> &lt;-<span class="st"> </span>k.area.all[no.match]
  no.match.<span class="dv">2</span> &lt;-<span class="st"> </span>area.all.<span class="dv">2</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">2</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">2</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop HY</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">2</span>, YEAR, NESPP3, SIZE, GEAR)
  <span class="kw">setkeyv</span>(k.area.all, <span class="kw">key</span>(no.match.<span class="dv">2</span>))
  area.all.<span class="dv">3</span> &lt;-<span class="st"> </span>k.area.all[no.match.<span class="dv">2</span>]
  no.match.<span class="dv">3</span> &lt;-<span class="st"> </span>area.all.<span class="dv">3</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">3</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">3</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop SIZE</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">3</span>, YEAR, NESPP3, GEAR)
  <span class="kw">setkeyv</span>(k.area.all, <span class="kw">key</span>(no.match.<span class="dv">3</span>))
  area.all.<span class="dv">4</span> &lt;-<span class="st"> </span>k.area.all[no.match.<span class="dv">3</span>]
  no.match.<span class="dv">4</span> &lt;-<span class="st"> </span>area.all.<span class="dv">4</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">4</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">4</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>,   <span class="st">&#39;SIZE&#39;</span>,   <span class="st">&#39;QY&#39;</span>,   <span class="st">&#39;HY&#39;</span>,  <span class="st">&#39;UTILCD&#39;</span>,  <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Drop GEAR</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">4</span>, YEAR, NESPP3)
  <span class="kw">setkeyv</span>(k.area.all, <span class="kw">key</span>(no.match.<span class="dv">4</span>))
  area.all.<span class="dv">5</span> &lt;-<span class="st"> </span>k.area.all[no.match.<span class="dv">4</span>]
  no.match.<span class="dv">5</span> &lt;-<span class="st"> </span>area.all.<span class="dv">5</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">5</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">5</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.GEAR&#39;</span>, <span class="st">&#39;i.SIZE&#39;</span>, <span class="st">&#39;i.QY&#39;</span>, <span class="st">&#39;i.HY&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, 
                         <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
                       <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;GEAR&#39;</span>, <span class="st">&#39;SIZE&#39;</span>, <span class="st">&#39;QY&#39;</span>, <span class="st">&#39;HY&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#Still no match - use 3 or 5 year window then drop year</span>
  years &lt;-<span class="st"> </span><span class="kw">unique</span>(no.match.<span class="dv">5</span>[, YEAR], <span class="dt">by =</span> <span class="kw">key</span>(no.match.<span class="dv">5</span>))
  no.match.<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">c</span>()
  area.all.<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">c</span>()
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(years)){
    <span class="co">#3 year window</span>
    k.area.3y &lt;-<span class="st"> </span>comland.agg[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>YEAR <span class="op">%in%</span><span class="st"> </span>(years[i] <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>(years[i] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>), ]
    <span class="kw">setkey</span>(k.area.3y, NESPP3, AREA)
    k.area.3y &lt;-<span class="st"> </span>k.area.3y[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                           by =<span class="st"> </span><span class="kw">c</span>(<span class="kw">key</span>(k.area.3y), <span class="st">&#39;UTILCD&#39;</span>)]
    <span class="kw">setnames</span>(k.area.3y, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    
    unk.area.3y &lt;-<span class="st"> </span>no.match.<span class="dv">5</span>[YEAR <span class="op">==</span><span class="st"> </span>years[i], ]
    
    <span class="kw">setkey</span>(unk.area.3y, NESPP3)
    <span class="kw">setkey</span>(k.area.3y,   NESPP3)
    area.3y &lt;-<span class="st"> </span>k.area.3y[unk.area.3y]
    
    no.match.3y &lt;-<span class="st"> </span>area.3y[<span class="kw">is.na</span>(SPPLIVMT), ]
    no.match.3y[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setnames</span>(no.match.3y, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
             <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    no.match.<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(no.match.<span class="dv">6</span>, no.match.3y))
    area.all.<span class="dv">6</span> &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(area.all.<span class="dv">6</span>, area.3y))
    }

  years &lt;-<span class="st"> </span><span class="kw">unique</span>(no.match.<span class="dv">6</span>[, YEAR], <span class="dt">by =</span> <span class="kw">key</span>(no.match.<span class="dv">6</span>))  
  no.match.<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">c</span>()
  area.all.<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">c</span>()  
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(years)){    
    <span class="co">#5 year window</span>
    k.area.5y &lt;-<span class="st"> </span>comland.agg[AREA <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>YEAR <span class="op">%in%</span><span class="st"> </span>(years[i] <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)<span class="op">:</span>(years[i] <span class="op">+</span><span class="st"> </span><span class="dv">2</span>), ]
    <span class="kw">setkey</span>(k.area.5y, NESPP3, AREA)
    k.area.5y &lt;-<span class="st"> </span>k.area.5y[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                           by =<span class="st"> </span><span class="kw">c</span>(<span class="kw">key</span>(k.area.5y), <span class="st">&#39;UTILCD&#39;</span>)]
    <span class="kw">setnames</span>(k.area.5y, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    
    unk.area.5y &lt;-<span class="st"> </span>no.match.<span class="dv">6</span>[YEAR <span class="op">==</span><span class="st"> </span>years[i], ]
    
    <span class="kw">setkey</span>(unk.area.5y, NESPP3)
    <span class="kw">setkey</span>(k.area.5y,   NESPP3)
    area.5y &lt;-<span class="st"> </span>k.area.5y[unk.area.5y] 
    
    no.match.5y &lt;-<span class="st"> </span>area.5y[<span class="kw">is.na</span>(SPPLIVMT), ]
    no.match.5y[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
    <span class="kw">setnames</span>(no.match.5y, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
             <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
    
    no.match.<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(no.match.<span class="dv">7</span>, no.match.5y))
    area.all.<span class="dv">7</span> &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(area.all.<span class="dv">7</span>, area.5y))
    }   
  <span class="co">#Drop year</span>
  <span class="kw">setkey</span>(no.match.<span class="dv">7</span>, NESPP3)
  k.area.all &lt;-<span class="st"> </span>k.area.all[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                           by =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;NESPP3&#39;</span>, <span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>)]
  <span class="kw">setnames</span>(k.area.all, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="kw">setkey</span>(k.area.all, NESPP3)
  
  area.all.<span class="dv">8</span> &lt;-<span class="st"> </span>k.area.all[no.match.<span class="dv">7</span>]
  no.match.<span class="dv">8</span> &lt;-<span class="st"> </span>area.all.<span class="dv">8</span>[<span class="kw">is.na</span>(SPPLIVMT), ]
  no.match.<span class="dv">8</span>[, <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(no.match.<span class="dv">8</span>, <span class="kw">c</span>(<span class="st">&#39;i.AREA&#39;</span>, <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>), 
           <span class="kw">c</span>(<span class="st">&#39;AREA&#39;</span>, <span class="st">&#39;UTILCD&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  <span class="co">#If still no match - leave as unknown</span>

  
  <span class="co">#Merge all together and proportion catch to known areas</span>
  area.all   &lt;-<span class="st"> </span>area.all  [<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  area.all.<span class="dv">2</span> &lt;-<span class="st"> </span>area.all.<span class="dv">2</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  area.all.<span class="dv">2</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  area.all.<span class="dv">2</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">2</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">3</span> &lt;-<span class="st"> </span>area.all.<span class="dv">3</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  area.all.<span class="dv">3</span>[, QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  area.all.<span class="dv">3</span>[, HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  area.all.<span class="dv">3</span>[, i.QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">3</span>[, i.HY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">3</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">4</span> &lt;-<span class="st"> </span>area.all.<span class="dv">4</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  area.all.<span class="dv">4</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  area.all.<span class="dv">4</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  area.all.<span class="dv">4</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  area.all.<span class="dv">4</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">4</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">4</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">4</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">5</span> &lt;-<span class="st"> </span>area.all.<span class="dv">5</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  area.all.<span class="dv">5</span>[, QY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.QY]
  area.all.<span class="dv">5</span>[, HY     <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.HY]
  area.all.<span class="dv">5</span>[, SIZE   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SIZE]
  area.all.<span class="dv">5</span>[, GEAR   <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.GEAR]
  area.all.<span class="dv">5</span>[, i.QY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">5</span>[, i.HY   <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">5</span>[, i.SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  area.all.<span class="dv">5</span>[, i.GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">5</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">6</span> &lt;-<span class="st"> </span>area.all.<span class="dv">6</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">6</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">7</span> &lt;-<span class="st"> </span>area.all.<span class="dv">7</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">7</span>, <span class="kw">names</span>(area.all))
  area.all.<span class="dv">8</span> &lt;-<span class="st"> </span>area.all.<span class="dv">8</span>[<span class="op">!</span><span class="kw">is.na</span>(SPPLIVMT), ]
  <span class="kw">setcolorder</span>(area.all.<span class="dv">8</span>, <span class="kw">names</span>(area.all))
  
  area.all &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(area.all,   area.all.<span class="dv">2</span>, area.all.<span class="dv">3</span>, area.all.<span class="dv">4</span>, 
                             area.all.<span class="dv">5</span>, area.all.<span class="dv">6</span>, area.all.<span class="dv">7</span>, area.all.<span class="dv">8</span>))
  
  area.all[, prop <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span>match.key]
  area.all[, unk  <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPLIVMT <span class="op">*</span><span class="st"> </span>prop]
  area.all[, unk2 <span class="op">:</span><span class="er">=</span><span class="st"> </span>i.SPPVALUE <span class="op">*</span><span class="st"> </span>prop]
  area.all[, <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>, <span class="st">&#39;i.SPPLIVMT&#39;</span>, <span class="st">&#39;i.SPPVALUE&#39;</span>, <span class="st">&#39;i.AREA&#39;</span>, 
               <span class="st">&#39;i.UTILCD&#39;</span>, <span class="st">&#39;prop&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setnames</span>(area.all, <span class="kw">c</span>(<span class="st">&#39;unk&#39;</span>,<span class="st">&#39;unk2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="kw">setcolorder</span>(no.match.<span class="dv">8</span>, <span class="kw">names</span>(area.all))
  area.solved &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(area.all, no.match.<span class="dv">8</span>))
  <span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;area.all&#39;</span>), <span class="kw">ls</span>(<span class="dt">pattern =</span> <span class="st">&#39;no.match&#39;</span>)))
  
  <span class="co">#Merge back area.solved</span>
  <span class="kw">setcolorder</span>(area.solved, <span class="kw">names</span>(comland.agg))
  comland.agg &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(k.area, area.solved))
  <span class="kw">setkey</span>(comland.agg,
         YEAR,
         QY,
         HY,
         SIZE,
         GEAR,
         AREA,
         NESPP3,
         UTILCD)
  comland.agg &lt;-<span class="st"> </span>comland.agg[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), 
                             by =<span class="st"> </span><span class="kw">key</span>(comland.agg)]
  <span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))  

<span class="co">#-------------------------------------------------------------------------------</span>
<span class="cf">if</span>(sum.by <span class="op">==</span><span class="st"> &#39;EPU&#39;</span>){
  <span class="co">#Assign EPU based on statarea</span>
  gom&lt;-<span class="kw">c</span>(<span class="dv">500</span>, <span class="dv">510</span>, <span class="dv">512</span><span class="op">:</span><span class="dv">515</span>)
  gb&lt;-<span class="kw">c</span>(<span class="dv">521</span><span class="op">:</span><span class="dv">526</span>, <span class="dv">551</span>, <span class="dv">552</span>, <span class="dv">561</span>, <span class="dv">562</span>)
  mab&lt;-<span class="kw">c</span>(<span class="dv">537</span>, <span class="dv">539</span>, <span class="dv">600</span>, <span class="dv">612</span><span class="op">:</span><span class="dv">616</span>, <span class="dv">621</span>, <span class="dv">622</span>, <span class="dv">625</span>, <span class="dv">626</span>, <span class="dv">631</span>, <span class="dv">632</span>)
  ss&lt;-<span class="kw">c</span>(<span class="dv">463</span><span class="op">:</span><span class="dv">467</span>, <span class="dv">511</span>)

  comland.agg[AREA <span class="op">%in%</span><span class="st"> </span>gom, EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;GOM&#39;</span>]
  comland.agg[AREA <span class="op">%in%</span><span class="st"> </span>gb,  EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;GB&#39;</span>]
  comland.agg[AREA <span class="op">%in%</span><span class="st"> </span>mab, EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;MAB&#39;</span>]
  comland.agg[AREA <span class="op">%in%</span><span class="st"> </span>ss,  EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;SS&#39;</span>]
  comland.agg[<span class="kw">is.na</span>(EPU),    EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;OTHER&#39;</span>]
  comland.agg[, EPU <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(EPU, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;GOM&#39;</span>, <span class="st">&#39;GB&#39;</span>, <span class="st">&#39;MAB&#39;</span>, <span class="st">&#39;SS&#39;</span>, <span class="st">&#39;OTHER&#39;</span>))]
 
  <span class="kw">setkey</span>(comland.agg,
         YEAR,
         NESPP3,
         QY,
         GEAR,
         SIZE,
         EPU,
         UTILCD)

  comland.agg &lt;-<span class="st"> </span>comland.agg[, <span class="kw">list</span>(<span class="kw">sum</span>(SPPLIVMT), <span class="kw">sum</span>(SPPVALUE)), by =<span class="st"> </span><span class="kw">key</span>(comland.agg)]
            
  <span class="kw">setnames</span>(comland.agg, <span class="kw">c</span>(<span class="st">&#39;V1&#39;</span>, <span class="st">&#39;V2&#39;</span>), <span class="kw">c</span>(<span class="st">&#39;SPPLIVMT&#39;</span>, <span class="st">&#39;SPPVALUE&#39;</span>))
  
  <span class="co">#Note - NAFO landings by division only so not available in sum.by = &quot;stat.area&quot;</span>
  <span class="co">#Add NAFO foreign landings - Data from http://www.nafo.int/data/frames/data.html</span>
  temp &lt;-<span class="st"> </span><span class="kw">tempfile</span>()
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-60-69.zip?ver=2016-08-03-063915-850&quot;</span>,temp)
  nafo.<span class="dv">60</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;NAFO21B-60-69.txt&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-70-79.zip?ver=2016-08-03-063915-850&quot;</span>,temp)
  nafo.<span class="dv">70</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;NAFO21B-70-79.txt&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-80-89.zip?ver=2016-08-03-063915-850&quot;</span>,temp)
  nafo.<span class="dv">80</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;NAFO21B-80-89.txt&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-90-99.zip?ver=2016-08-03-063915-850&quot;</span>,temp)
  nafo.<span class="dv">90</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;NAFO21B-90-99.txt&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-2000-09.zip?ver=2016-08-03-063915-850&quot;</span>,temp)
  nafo.<span class="dv">00</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;NAFO21B-2000-09.txt&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  <span class="kw">download.file</span>(<span class="st">&quot;https://www.nafo.int/Portals/0/Stats/nafo-21b-2010-15.zip?ver=2017-06-01-164323-460&quot;</span>,temp)
  nafo.<span class="dv">10</span> &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">unz</span>(temp, <span class="st">&quot;nafo-21b-2010-15/NAFO21B-2010-15.csv&quot;</span>)))
  <span class="kw">unlink</span>(temp)
  
  <span class="co">#2010 + data have different column headers</span>
  <span class="kw">setnames</span>(nafo.<span class="dv">10</span>,
          <span class="kw">c</span>(<span class="st">&#39;Gear&#39;</span>, <span class="st">&#39;AreaCode&#39;</span>, <span class="st">&#39;SpeciesEffort&#39;</span>),
          <span class="kw">c</span>(<span class="st">&#39;GearCode&#39;</span>, <span class="st">&#39;Divcode&#39;</span>, <span class="st">&#39;Code&#39;</span>))
          
  nafo &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(nafo.<span class="dv">60</span>, nafo.<span class="dv">70</span>, nafo.<span class="dv">80</span>, nafo.<span class="dv">90</span>, nafo.<span class="dv">00</span>, nafo.<span class="dv">10</span>))
  
  <span class="co">#Remove US landings (Country code 22), extra divisions (use only 47, 51:56, 61:63),</span>
  <span class="co">#and effort codes (1:3)</span>
  nafo &lt;-<span class="st"> </span>nafo[Country <span class="op">!=</span><span class="st"> </span><span class="dv">22</span> <span class="op">&amp;</span><span class="st"> </span>Divcode <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">47</span>, <span class="dv">51</span><span class="op">:</span><span class="dv">56</span>, <span class="dv">61</span><span class="op">:</span><span class="dv">63</span>) <span class="op">&amp;</span><span class="st"> </span>Code <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>, ]
  
  <span class="co">#Deal with unknown monthly catch?????</span>
  
  <span class="co">#Get nafo code in a similar format to comland</span>
  nafoland &lt;-<span class="st"> </span>nafo[, <span class="kw">list</span>(Year, GearCode, Tonnage, Divcode, Code, Catches)]
  nafoland[, MONTH <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  <span class="kw">setnames</span>(nafoland, <span class="st">&#39;Catches&#39;</span>, <span class="st">&#39;SPPLIVMT&#39;</span>)
  
  month &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Jan&#39;</span>, <span class="st">&#39;Feb&#39;</span>, <span class="st">&#39;Mar&#39;</span>, <span class="st">&#39;Apr&#39;</span>, <span class="st">&#39;May&#39;</span>, <span class="st">&#39;Jun&#39;</span>, <span class="st">&#39;Jul&#39;</span>, <span class="st">&#39;Aug&#39;</span>, <span class="st">&#39;Sep&#39;</span>, <span class="st">&#39;Oct&#39;</span>, <span class="st">&#39;Nov&#39;</span>, <span class="st">&#39;Dec&#39;</span>)
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">12</span>){
    nafoland.month &lt;-<span class="st"> </span>nafo[, <span class="kw">list</span>(Year, GearCode, Tonnage, Divcode, Code, <span class="kw">get</span>(month[i]))]
    nafoland.month[, MONTH <span class="op">:</span><span class="er">=</span><span class="st"> </span>i]
    <span class="kw">setnames</span>(nafoland.month,
            <span class="kw">names</span>(nafoland.month)[<span class="dv">6</span>],
            <span class="st">&#39;SPPLIVMT&#39;</span>)
    nafoland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(nafoland, nafoland.month))
    }
  
  nafoland &lt;-<span class="st"> </span>nafoland[SPPLIVMT <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>,]
  
  nafoland[, EPU <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">factor</span>(<span class="ot">NA</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&#39;GOM&#39;</span>, <span class="st">&#39;GB&#39;</span>, <span class="st">&#39;MAB&#39;</span>, <span class="st">&#39;SS&#39;</span>, <span class="st">&#39;OTHER&#39;</span>))]
  nafoland[Divcode <span class="op">==</span><span class="st"> </span><span class="dv">47</span>,             EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;SS&#39;</span>]
  nafoland[Divcode <span class="op">==</span><span class="st"> </span><span class="dv">51</span>,             EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;GOM&#39;</span>]
  nafoland[Divcode <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">52</span>, <span class="dv">54</span><span class="op">:</span><span class="dv">56</span>), EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;GB&#39;</span>]
  nafoland[Divcode <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">53</span>, <span class="dv">61</span><span class="op">:</span><span class="dv">63</span>), EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;MAB&#39;</span>]
  nafoland[<span class="kw">is.na</span>(EPU),                EPU <span class="op">:</span><span class="er">=</span><span class="st"> &#39;OTHER&#39;</span>]
  
  nafoland[, Divcode <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  ##Fix missing Scotian Shelf data from 21B
  SS.nafo &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">file.path</span>(data.dir.<span class="dv">3</span>, <span class="st">&quot;SS_NAFO_21A.csv&quot;</span>), <span class="dt">skip =</span> <span class="dv">8</span>))
  
  <span class="co">#Add NAFOSPP code to SS.nafo</span>
  nafo.spp &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">read.csv</span>(<span class="kw">file.path</span>(data.dir.<span class="dv">3</span>, <span class="st">&#39;species.txt&#39;</span>)))
  <span class="kw">setnames</span>(nafo.spp, <span class="st">&quot;Abbreviation&quot;</span>, <span class="st">&quot;Species_ASFIS&quot;</span>)
  nafo.spp &lt;-<span class="st"> </span>nafo.spp[, <span class="kw">list</span>(Code, Species_ASFIS)]
  
  SS.nafo &lt;-<span class="st"> </span><span class="kw">merge</span>(SS.nafo, nafo.spp, <span class="dt">by =</span> <span class="st">&#39;Species_ASFIS&#39;</span>, <span class="dt">all.x =</span> T)
  
  <span class="co">#Only grab missing data</span>
  SS.nafo &lt;-<span class="st"> </span>SS.nafo[Year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2003</span>, <span class="dv">2008</span>, <span class="dv">2009</span>), ]
  
  <span class="kw">setkey</span>(SS.nafo,
         Year,
         Code)
  
  SS.land &lt;-<span class="st"> </span>SS.nafo[, <span class="kw">sum</span>(Catch...<span class="fl">000.</span>Kg.), by =<span class="st"> </span><span class="kw">key</span>(SS.nafo)]
  
  <span class="kw">setnames</span>(SS.land, <span class="st">&quot;V1&quot;</span>, <span class="st">&quot;SPPLIVMT&quot;</span>)
  
  <span class="co">#Add GearCode, Tonnage, Month, and EPU </span>
  SS.land[, GearCode <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">99</span>]
  SS.land[, Tonnage  <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  SS.land[, MONTH    <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  SS.land[, EPU      <span class="op">:</span><span class="er">=</span><span class="st"> &#39;SS&#39;</span>]
  
  <span class="kw">setcolorder</span>(SS.land, <span class="kw">names</span>(nafoland))
  
  nafoland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(nafoland, SS.land))
  
  <span class="co">#Rectify NAFO codes with US codes</span>
  <span class="co">#Species</span>
  <span class="kw">setnames</span>(nafoland,
          <span class="kw">c</span>(<span class="st">&#39;Year&#39;</span>, <span class="st">&#39;GearCode&#39;</span>, <span class="st">&#39;Tonnage&#39;</span>, <span class="st">&#39;Code&#39;</span>),
          <span class="kw">c</span>(<span class="st">&#39;YEAR&#39;</span>, <span class="st">&#39;NAFOGEAR&#39;</span>, <span class="st">&#39;TONCL1&#39;</span>, <span class="st">&#39;NAFOSPP&#39;</span>))
  
  spp &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">sqlQuery</span>(channel, <span class="st">&quot;select NAFOSPP, NESPP3 from CFSPP&quot;</span>))
  
  <span class="co">#Fix missing NAFO codes</span>
  missing.spp &lt;-<span class="st"> </span><span class="kw">data.table</span>(<span class="dt">NAFOSPP =</span> <span class="kw">c</span>(<span class="dv">110</span>, <span class="dv">141</span>, <span class="dv">189</span>, <span class="dv">480</span>, <span class="dv">484</span>, <span class="dv">487</span>, <span class="dv">488</span>, <span class="dv">489</span>),
                            <span class="dt">NESPP3  =</span> <span class="kw">c</span>(<span class="dv">240</span>, <span class="dv">509</span>, <span class="dv">512</span>, <span class="dv">366</span>, <span class="dv">368</span>, <span class="dv">367</span>, <span class="dv">370</span>, <span class="dv">369</span>))
  spp &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(spp, missing.spp))
  
  <span class="kw">setkey</span>(spp, NAFOSPP)
  spp &lt;-<span class="st"> </span><span class="kw">unique</span>(spp, <span class="dt">by =</span> <span class="kw">key</span>(spp))
  
  <span class="co">#Fix many to one relationships</span>
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">199</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">524</span>]
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">299</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">525</span>]
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">469</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">359</span>]
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">499</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">526</span>]
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">529</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">764</span>]
  spp[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">699</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">899</span>]
  
  nafoland &lt;-<span class="st"> </span><span class="kw">merge</span>(nafoland, spp, <span class="dt">by =</span> <span class="st">&#39;NAFOSPP&#39;</span>, <span class="dt">all.x =</span> T)
  
  <span class="co">#fix codes</span>
  nafoland[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">309</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>150L]
  nafoland[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">462</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>481L]
  nafoland[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">464</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>355L]
  nafoland[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">468</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>493L]
  nafoland[NAFOSPP <span class="op">==</span><span class="st"> </span><span class="dv">704</span>, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>817L]
  
  <span class="co">#remove species without a match</span>
  nafoland &lt;-<span class="st"> </span>nafoland[<span class="op">!</span><span class="kw">is.na</span>(NESPP3), ]
  
  <span class="co">#Remove herring catch - already included from Maine Data earlier</span>
  nafoland &lt;-<span class="st"> </span>nafoland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">168</span>, ]
  
  <span class="co">#Gearcodes</span>
  gear &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">sqlQuery</span>(channel, <span class="st">&quot;select NEGEAR, NAFOGEAR from Gear&quot;</span>))
  gear &lt;-<span class="st"> </span><span class="kw">unique</span>(gear, <span class="dt">by =</span> <span class="st">&#39;NAFOGEAR&#39;</span>)
  
  nafoland &lt;-<span class="st"> </span><span class="kw">merge</span>(nafoland, gear, <span class="dt">by =</span> <span class="st">&#39;NAFOGEAR&#39;</span>, <span class="dt">all.x =</span> T)
  
  <span class="co">#fix codes</span>
  nafoland[NAFOGEAR <span class="op">==</span><span class="st"> </span><span class="dv">8</span>,  NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>50L]
  nafoland[NAFOGEAR <span class="op">==</span><span class="st"> </span><span class="dv">9</span>,  NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>370L]
  nafoland[NAFOGEAR <span class="op">==</span><span class="st"> </span><span class="dv">19</span>, NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>58L]
  nafoland[NAFOGEAR <span class="op">==</span><span class="st"> </span><span class="dv">49</span>, NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>60L]
  nafoland[NAFOGEAR <span class="op">==</span><span class="st"> </span><span class="dv">56</span>, NEGEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span>21L]
  
  <span class="co">#Tonnage</span>
  nafoland[TONCL1 <span class="op">==</span><span class="st"> </span><span class="dv">7</span>, TONCL1 <span class="op">:</span><span class="er">=</span><span class="st"> </span>6L]
  
  <span class="co">#Drop NAFO codes</span>
  nafoland[, <span class="kw">c</span>(<span class="st">&#39;NAFOGEAR&#39;</span>, <span class="st">&#39;NAFOSPP&#39;</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  
  <span class="co">#Fix skates</span>
  <span class="co">#get little skates and winter skates from skates(ns) - use survey in half years</span>
  <span class="co">#Generate Half year variable in comland</span>
  nafoland.skates &lt;-<span class="st"> </span>nafoland[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">365</span>, ]
  nafoland.skates[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  nafoland.skates[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">12</span>, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]
  
  <span class="kw">setkey</span>(skate.hake.nafo,
         YEAR,
         Half,
         EPU)
  
  nafoland.skates &lt;-<span class="st"> </span><span class="kw">merge</span>(nafoland.skates, skate.hake.nafo, <span class="dt">by =</span> <span class="kw">key</span>(skate.hake.nafo), <span class="dt">all.x =</span> T)
  
  nafoland.skates[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">365</span>, little <span class="op">:</span><span class="er">=</span><span class="st"> </span>little.per <span class="op">*</span><span class="st"> </span>SPPLIVMT]
  nafoland.skates[<span class="kw">is.na</span>(little), little <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  nafoland.skates[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">365</span>, winter <span class="op">:</span><span class="er">=</span><span class="st"> </span>winter.per <span class="op">*</span><span class="st"> </span>SPPLIVMT]
  nafoland.skates[<span class="kw">is.na</span>(winter), winter <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  nafoland.skates[NESPP3 <span class="op">==</span><span class="st"> </span><span class="dv">365</span>, other.skate <span class="op">:</span><span class="er">=</span><span class="st"> </span>SPPLIVMT <span class="op">-</span><span class="st"> </span>(little <span class="op">+</span><span class="st"> </span>winter)]
  
  <span class="co">#Little (366), winter (367), skates(ns) (365)</span>
  <span class="co">#put skates in nafoland format to merge back</span>
  little &lt;-<span class="st"> </span>nafoland.skates[, <span class="kw">list</span>(YEAR, Half, EPU, TONCL1, MONTH, 
                                   NESPP3, NEGEAR, little)]
  little[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>366L]
  <span class="kw">setnames</span>(little, <span class="st">&quot;little&quot;</span>, <span class="st">&quot;SPPLIVMT&quot;</span>)
  little &lt;-<span class="st"> </span>little[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]
  
  winter &lt;-<span class="st"> </span>nafoland.skates[, <span class="kw">list</span>(YEAR, Half, EPU, TONCL1, MONTH, 
                                   NESPP3, NEGEAR, winter)]
  winter[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>367L]
  <span class="kw">setnames</span>(winter, <span class="st">&quot;winter&quot;</span>, <span class="st">&quot;SPPLIVMT&quot;</span>)
  winter &lt;-<span class="st"> </span>winter[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]
  
  other &lt;-<span class="st"> </span>nafoland.skates[, <span class="kw">list</span>(YEAR, Half, EPU, TONCL1, MONTH, 
                                  NESPP3, NEGEAR, other.skate)]
  other[, NESPP3 <span class="op">:</span><span class="er">=</span><span class="st"> </span>365L]
  <span class="kw">setnames</span>(other, <span class="st">&quot;other.skate&quot;</span>, <span class="st">&quot;SPPLIVMT&quot;</span>)
  other &lt;-<span class="st"> </span>other[SPPLIVMT <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, ]
  
  <span class="co">#merge all three and reformat for nafoland</span>
  skates.add.back &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(little, winter, other))
  
  skates.add.back[, Half <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="ot">NULL</span>]
  <span class="kw">setcolorder</span>(skates.add.back, <span class="kw">names</span>(nafoland))
  
  nafoland &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(nafoland[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">365</span>, ], skates.add.back))  
  
  <span class="co">#aggregate nafo landings</span>
  <span class="co">#2 - aggregate by quarter year, half year, major gear, and small/large TC</span>
  nafoland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  nafoland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">4</span><span class="op">:</span><span class="dv">6</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">2</span>]
  nafoland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">7</span><span class="op">:</span><span class="dv">9</span>,   QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">3</span>]
  nafoland[MONTH <span class="op">%in%</span><span class="st"> </span><span class="dv">10</span><span class="op">:</span><span class="dv">12</span>, QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">4</span>]
  nafoland[MONTH <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,       QY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">1</span>]
  
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>otter,     GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;otter&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>dredge.sc, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;dredge.sc&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>pot,       GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;pot&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>longline,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;longline&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>seine,     GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;seine&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>gillnet,   GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;gillnet&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>midwater,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;midwater&#39;</span>]
  nafoland[NEGEAR <span class="op">%in%</span><span class="st"> </span>dredge.o,  GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;dredge.o&#39;</span>]
  nafoland[NEGEAR <span class="op">==</span><span class="st"> </span><span class="dv">99</span>,          GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;unknown&#39;</span>]
  nafoland[<span class="kw">is.na</span>(GEAR),           GEAR <span class="op">:</span><span class="er">=</span><span class="st"> &#39;other&#39;</span>]
  nafoland[, GEAR <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(GEAR)]
  
  nafoland[TONCL1 <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;small&#39;</span>]
  nafoland[TONCL1 <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>,      SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;large&#39;</span>]
  nafoland[TONCL1 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,     SIZE <span class="op">:</span><span class="er">=</span><span class="st"> &#39;unknown&#39;</span>]
  nafoland[, SIZE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">as.factor</span>(SIZE)]
  
  <span class="kw">setkey</span>(nafoland,
         YEAR,
         QY,
         GEAR,
         SIZE,
         EPU,
         NESPP3)
  
  nafoland.agg &lt;-<span class="st"> </span>nafoland[, <span class="kw">sum</span>(SPPLIVMT), by =<span class="st"> </span><span class="kw">key</span>(nafoland)]
  
  <span class="kw">setnames</span>(nafoland.agg, <span class="st">&quot;V1&quot;</span>, <span class="st">&quot;SPPLIVMT&quot;</span>)
  
  <span class="co">#Create dummy variable for value</span>
  nafoland.agg[, SPPVALUE <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  nafoland.agg[, UTILCD <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]
  
  <span class="co">#Merge comland and nafoland</span>
  <span class="kw">setcolorder</span>(nafoland.agg, <span class="kw">names</span>(comland.agg))       
  
  <span class="cf">if</span>(foreign <span class="op">==</span><span class="st"> &#39;y&#39;</span>){
    comland.agg[,  US <span class="op">:</span><span class="er">=</span><span class="st"> </span>T]
    nafoland.agg[, US <span class="op">:</span><span class="er">=</span><span class="st"> </span>F]
  }
  
  comland.nafo &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">list</span>(comland.agg, nafoland.agg))
  
  <span class="co">#Remove Menhaden data</span>
  <span class="co">#save(comland.nafo, file = paste(out.dir, &quot;comland_Menhaden.RData&quot;, sep = &#39;&#39;))</span>
  comland &lt;-<span class="st"> </span>comland.nafo[NESPP3 <span class="op">!=</span><span class="st"> </span><span class="dv">221</span>, ]
}

<span class="cf">if</span>(sum.by <span class="op">==</span><span class="st"> &#39;stat.area&#39;</span>) comland &lt;-<span class="st"> </span>comland.agg
  
<span class="co">#Output file</span>
<span class="cf">if</span>(landed     <span class="op">==</span><span class="st"> &#39;n&#39;</span>) file.landed &lt;-<span class="st"> &#39;&#39;</span> <span class="cf">else</span> file.landed &lt;-<span class="st"> &#39;_meatwt&#39;</span>
<span class="cf">if</span>(adjust.ppi <span class="op">==</span><span class="st"> &#39;n&#39;</span>) file.adjust &lt;-<span class="st"> &#39;&#39;</span> <span class="cf">else</span> file.adjust &lt;-<span class="st"> &#39;_deflated&#39;</span>
<span class="cf">if</span>(sum.by <span class="op">==</span><span class="st"> &#39;EPU&#39;</span>) file.by &lt;-<span class="st"> &#39;&#39;</span> <span class="cf">else</span> file.by &lt;-<span class="st"> &#39;_stat_areas&#39;</span>
file.name &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&#39;comland&#39;</span>, file.landed, file.adjust, file.by, <span class="st">&#39;.RData&#39;</span>)

<span class="kw">save</span>(comland, <span class="dt">file =</span> <span class="kw">file.path</span>(out.dir, file.name))</code></pre></div>
<div id="data-processing-9" class="section level4">
<h4><span class="header-section-number">17.1.2.1</span> Data Processing</h4>
<p>The landings data were formatted for inclusion in the ecodata R package with the following R code.</p>
<!-- {{ProcessStart}} -->
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Process commerical data</span>


<span class="co"># These data were derived from the Commercial Fisheries Database Biological Sample. More information about</span>
<span class="co"># these data are available at https://noaa-edab.github.io/tech-doc/comdat.html</span>

<span class="kw">library</span>(dplyr)


raw.dir &lt;-<span class="st"> </span>here<span class="op">::</span><span class="kw">here</span>(<span class="st">&quot;data-raw&quot;</span>)

get_comdat &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">save_clean =</span> F){
  
  <span class="kw">load</span>(<span class="kw">file.path</span>(raw.dir,<span class="st">&quot;Commercial_data_pull_19.RData&quot;</span>))
  
  commercial &lt;-<span class="st"> </span>commercial <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">rename</span>(<span class="dt">EPU =</span> Region) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>Source)
  
  <span class="cf">if</span> (save_clean){
    usethis<span class="op">::</span><span class="kw">use_data</span>(comdat, <span class="dt">overwrite =</span> T)
  } <span class="cf">else</span> {
    <span class="kw">return</span>(comdat)
  }

}</code></pre></div>
<!-- {{ProcessEnd}} -->
</div>
</div>
<div id="data-analysis-14" class="section level3">
<h3><span class="header-section-number">17.1.3</span> Data analysis</h3>
<p>Fisheries dependent data from Comlands is used in several indicators for the State of the Ecosystem report; the more complicated analyses are detailed in their own sections. The most straightforward use of this data are the aggregate landings indicators. These are calculated by first assigning the various species into <a href="aggroups.html#aggroups">aggregate groups</a>. Species are also marked by which management body manages them. Landings are then summed by year, <a href="epu.html#epu">EPU</a>, aggregate group, and whether they are managed or not. Both managed and unmanaged totals are added together to get the final amount of total landings for that aggregate group within its respective region. Both the total and those landings managed by the management body receiving the report are reported. Proportions of managed landings to total landings are also reported in tabular form.</p>
</div>
<div id="plotting-10" class="section level3">
<h3><span class="header-section-number">17.1.4</span> Plotting</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Relative working directories</span>
data.dir  &lt;-<span class="st"> </span>here<span class="op">::</span><span class="kw">here</span>(<span class="st">&#39;data&#39;</span>)
r.dir &lt;-<span class="st"> </span>here<span class="op">::</span><span class="kw">here</span>(<span class="st">&#39;R&#39;</span>)

<span class="co"># Load data</span>
<span class="kw">load</span>(<span class="kw">file.path</span>(data.dir,<span class="st">&quot;SOE_data_erddap.Rdata&quot;</span>))

<span class="co"># Source plotting functions</span>
<span class="kw">source</span>(<span class="kw">file.path</span>(r.dir,<span class="st">&quot;BasePlot_source.R&quot;</span>))

## Ecosystem-wide and managed species total landings
opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">oma =</span> <span class="kw">c</span>(<span class="dv">4</span>, <span class="fl">6.5</span>, <span class="dv">2</span>, <span class="dv">6</span>))

<span class="kw">soe.plot</span>(SOE.data, <span class="st">&quot;Time&quot;</span>,<span class="st">&quot;Apex Predator Landings GB&quot;</span>, <span class="dt">stacked =</span> <span class="st">&quot;A&quot;</span>,<span class="dt">status =</span> F,
         <span class="dt">endshade =</span> T, <span class="dt">rel.y.num =</span> <span class="fl">1.1</span>, <span class="dt">full.trend =</span> T, <span class="dt">scale.axis =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">3</span>,<span class="dt">end.start =</span> <span class="dv">2007</span>, <span class="dt">x.start =</span> <span class="dv">1986</span>,
         <span class="dt">ymin =</span> <span class="ot">FALSE</span>, <span class="dt">y.lower =</span> <span class="dv">0</span>,<span class="dt">cex.stacked =</span> <span class="fl">1.5</span> )

<span class="kw">soe.plot</span>(SOE.data, <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Piscivore Landings GB&quot;</span>, <span class="dt">stacked =</span> <span class="st">&quot;B&quot;</span>,<span class="dt">status =</span> F,
         <span class="dt">endshade =</span> T, <span class="dt">rel.y.num =</span> <span class="fl">1.1</span>, <span class="dt">full.trend =</span> T, <span class="dt">scale.axis =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">3</span>,<span class="dt">end.start =</span> <span class="dv">2007</span>, <span class="dt">x.start =</span> <span class="dv">1986</span>,
         <span class="dt">ymin =</span> <span class="ot">FALSE</span>, <span class="dt">y.lower =</span> <span class="dv">0</span> , <span class="dt">extra =</span> <span class="ot">TRUE</span>, <span class="dt">x.var2 =</span> <span class="st">&quot;Time&quot;</span>, 
         <span class="dt">y.var2 =</span> <span class="st">&quot;Piscivore NEFMC managed species sea food GB&quot;</span>,<span class="dt">cex.stacked =</span> <span class="fl">1.5</span>)

<span class="kw">soe.plot</span>(SOE.data, <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Planktivore Landings GB&quot;</span>, <span class="dt">stacked =</span> <span class="st">&quot;C&quot;</span>,<span class="dt">status =</span> F,
         <span class="dt">endshade =</span> T, <span class="dt">rel.y.num =</span> <span class="fl">1.1</span>, <span class="dt">full.trend =</span> T, <span class="dt">scale.axis =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">3</span>,<span class="dt">end.start =</span> <span class="dv">2007</span>, <span class="dt">x.start =</span> <span class="dv">1986</span>,
         <span class="dt">ymin =</span> <span class="ot">FALSE</span>, <span class="dt">y.lower =</span> <span class="dv">0</span> , <span class="dt">extra =</span> <span class="ot">TRUE</span>, <span class="dt">x.var2 =</span> <span class="st">&quot;Time&quot;</span>, 
         <span class="dt">y.var2 =</span> <span class="st">&quot;Planktivore NEFMC managed species sea food GB&quot;</span>,<span class="dt">cex.stacked =</span> <span class="fl">1.5</span>)

<span class="kw">soe.plot</span>(SOE.data, <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Benthivore Landings GB&quot;</span>, <span class="dt">stacked =</span> <span class="st">&quot;D&quot;</span>,<span class="dt">status =</span> F,
         <span class="dt">endshade =</span> T, <span class="dt">rel.y.num =</span> <span class="fl">1.1</span>, <span class="dt">full.trend =</span> T, <span class="dt">scale.axis =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">3</span>,<span class="dt">end.start =</span> <span class="dv">2007</span>, <span class="dt">x.start =</span> <span class="dv">1986</span>,
         <span class="dt">ymin =</span> <span class="ot">FALSE</span>, <span class="dt">y.lower =</span> <span class="dv">0</span> , <span class="dt">extra =</span> <span class="ot">TRUE</span>, <span class="dt">x.var2 =</span> <span class="st">&quot;Time&quot;</span>, 
         <span class="dt">y.var2 =</span> <span class="st">&quot;Benthivore NEFMC managed species sea food GB&quot;</span>,<span class="dt">cex.stacked =</span> <span class="fl">1.5</span>)

<span class="kw">soe.plot</span>(SOE.data, <span class="st">&quot;Time&quot;</span>, <span class="st">&quot;Benthos Landings GB&quot;</span>, <span class="dt">stacked =</span> <span class="st">&quot;E&quot;</span>,<span class="dt">status =</span> F,
         <span class="dt">endshade =</span> T, <span class="dt">rel.y.num =</span> <span class="fl">1.1</span>, <span class="dt">full.trend =</span> T, <span class="dt">scale.axis =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">3</span>,<span class="dt">end.start =</span> <span class="dv">2007</span>, <span class="dt">x.start =</span> <span class="dv">1986</span>,
         <span class="dt">ymin =</span> <span class="ot">FALSE</span>, <span class="dt">y.lower =</span> <span class="dv">0</span> , <span class="dt">extra =</span> <span class="ot">TRUE</span>, <span class="dt">x.var2 =</span> <span class="st">&quot;Time&quot;</span>, 
         <span class="dt">y.var2 =</span> <span class="st">&quot;Benthos NEFMC managed species sea food GB&quot;</span>,<span class="dt">cex.stacked =</span> <span class="fl">1.5</span>)

<span class="kw">soe.stacked.axis</span>(<span class="st">&quot;Year&quot;</span>, <span class="kw">expression</span>(<span class="st">&quot;Landings, 10&quot;</span><span class="op">^</span><span class="dv">3</span><span class="op">*</span><span class="st">&quot;metric tons&quot;</span>), <span class="dt">x.line =</span> <span class="fl">2.7</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:seafood-landings"></span>
<img src="_main_files/figure-html/seafood-landings-1.png" alt="NEFMC seafood specific landings (red) and total commericial landings (black) in Georges Bank (A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos)." width="672" />
<p class="caption">
Figure 17.2: NEFMC seafood specific landings (red) and total commericial landings (black) in Georges Bank (A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos).
</p>
</div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="ichthyoplankton-diversity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="long-term-sea-surface-temperature.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/NOAA-EDAB/tech-doc/edit/master/chapters/landings_data.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"toc": {
"collapse": "section"
},
"toolbar": {
"position": "static"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
